EasySocial.module("apps/fields/event/recurring/content",function(a){var b=this,c=EasySocial.options.momentLang;EasySocial.require().library("datetimepicker","moment/"+c).done(function(){EasySocial.Controller("Field.Event.Recurring",{defaultOptions:{dateFormat:"",id:null,value:{},allday:0,showWarningMessages:0,eventId:null,dow:0,"{type}":"[data-recurring-type]","{endBlock}":"[data-recurring-end-block]","{picker}":"[data-recurring-end-picker]","{toggle}":"[data-recurring-end-toggle]","{result}":"[data-recurring-end-result]","{dailyBlock}":"[data-recurring-daily-block]","{dailyInput}":"[data-recurring-daily-block] input","{summaryBlock}":"[data-recurring-summary-block]","{showSchedules}":"[data-show-schedules]","{scheduleLoadingBlock}":"[data-recurring-schedule-loading-block]","{deleteRecurringButton}":"[data-recurring-delete]"}},function(b){return{init:function(){var d=b.options.dateFormat,e=b.options.dow;b.picker()._datetimepicker({pickTime:!1,component:"es",useCurrent:!1,format:d,language:c,dow:e});var f=b.result().val();if(!a.isEmpty(f)){var g=a.moment(f);b.datetimepicker("setDate",g)}b.calculateRecurringEvents()},changed:0,"{window} easysocial.fields.allday.change":function(a,c,d){b.options.allday=d,b.calculateRecurringEvents()},"{window} easysocial.fields.startend.start.change":function(){b.calculateRecurringEvents()},"{toggle} click":function(){b.picker().focus()},"{picker} dp.change":function(a,c){b.setDateValue(c.date.toDate()),b.detectChanges(),b.calculateRecurringEvents()},"{type} change":function(a){var d=a.val();b.endBlock()["none"===d?"hide":"show"](),b.dailyBlock()["daily"===d?"show":"hide"](),b.detectChanges(),b.calculateRecurringEvents()},"{dailyInput} change":function(){b.detectChanges(),b.calculateRecurringEvents()},calculateRecurringEvents:function(){b.summaryBlock().hide(),b.scheduleLoadingBlock().hide(),b.clearError();var c=a("[data-event-start]").find("[data-datetime]").val(),d=a("[data-event-timezone]").val(),e=b.result().val(),f=b.type().val(),g=[];("none"!=f||b.options.showWarningMessages)&&(a.isEmpty(c)||a.isEmpty(e)||a.isEmpty(f)||(a.each(b.dailyBlock().find("input"),function(b,c){el=a(c),el.is(":checked")&&g.push(el.val())}),b.scheduleLoadingBlock().show(),b.getTotalRecurring({start:c,timezone:d,end:e,type:f,daily:g})))},getTotalRecurring:a.debounce(function(a){b.clearError(),EasySocial.ajax("fields/event/recurring/calculateRecurringEvents",{id:b.options.id,start:a.start,timezone:a.timezone,allday:b.options.allday,end:a.end,type:a.type,daily:a.daily,eventId:b.options.eventId,changed:b.changed,showWarningMessages:b.options.showWarningMessages}).done(function(a){b.summaryBlock().html(a).show()}).fail(function(a){b.raiseError(a)}).always(function(){b.scheduleLoadingBlock().hide()})},500),detectChanges:function(){var c=b.result().val(),d=b.type().val(),e=[],f=!1;a.each(b.dailyBlock().find("input"),function(b,c){el=a(c),el.is(":checked")&&e.push(el.val())}),(d!=b.options.value.type||c!=b.options.value.end||e.length!=b.options.value.daily.length)&&(f=!0),a.each(e,function(c,d){return-1==a.inArray(d,b.options.value.daily)?(f=!0,!1):void 0}),a.each(b.options.value.daily,function(b,c){return-1==a.inArray(c,e)?(f=!0,!1):void 0}),b.changed=f?1:0,a(window).trigger("easysocial.fields.recurring.changed",[f])},"{showSchedules} click":function(){var e=a("[data-event-start]").find("[data-datetime]").val(),f=a("[data-event-timezone]").val(),g=b.result().val(),h=b.type().val(),i=[];a.each(b.dailyBlock().find("input"),function(b,c){el=a(c),el.is(":checked")&&i.push(el.val())}),EasySocial.dialog({content:EasySocial.ajax("fields/event/recurring/getScheduledEvents",{id:b.options.id,start:e,timezone:f,allday:b.options.allday,end:g,type:h,daily:i,eventId:b.options.eventId})})},"{deleteRecurringButton} click":function(){EasySocial.dialog({content:EasySocial.ajax("site/views/events/deleteRecurringDialog",{id:b.options.eventId}),bindings:{"{submitButton} click":function(){b.deleteRecurring().done(function(){EasySocial.dialog().close(),b.calculateRecurringEvents()})}}})},deleteRecurring:function(){return EasySocial.ajax("site/controllers/events/deleteRecurring",{eventId:b.options.eventId})},datetimepicker:function(a,c){return b.picker().data("DateTimePicker")[a](c)},setDateValue:function(a){b.result().val(a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2)+" "+("00"+a.getHours()).slice(-2)+":"+("00"+a.getMinutes()).slice(-2)+":"+("00"+a.getSeconds()).slice(-2))},"{self} onSubmit":function(a,b,c){c.push(!0)},raiseError:function(a){b.trigger("error",[a])},clearError:function(){b.trigger("clear")}}}),b.resolve()})});