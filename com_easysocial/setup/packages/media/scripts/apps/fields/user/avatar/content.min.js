EasySocial.module("apps/fields/user/avatar/content",function(a){var b=this;EasySocial.require().library("image","imgareaselect").done(function(){EasySocial.Controller("Field.Avatar",{defaultOptions:{required:!1,id:0,group:null,categoryId:0,origSource:null,defaultAvatar:null,hasAvatar:null,"{field}":"[data-field-avatar]","{gallery}":"[data-field-avatar-gallery]","{galleryList}":"[data-field-avatar-gallery-items]","{galleryItem}":"[data-field-avatar-gallery-item]","{frame}":"[data-field-avatar-frame]","{viewport}":"[data-field-avatar-viewport]","{avatarSource}":"[data-field-avatar-source]","{avatarData}":"[data-field-avatar-data]","{avatarPath}":"[data-field-avatar-path]","{avatarType}":"[data-field-avatar-type]","{avatarName}":"[data-field-avatar-name]","{file}":"[data-field-avatar-file]","{image}":"[data-field-avatar-selected]","{note}":"[data-field-avatar-note]","{error}":"[data-field-avatar-error]","{actions}":"[data-field-avatar-actions]","{cancel}":"[data-field-avatar-actions-cancel]","{crop}":"[data-field-avatar-actions-crop]","{removeFrame}":"[data-field-avatar-remove]","{remove}":"[data-field-avatar-remove-button]","{revertFrame}":"[data-field-avatar-revert]","{revert}":"[data-field-avatar-revert-button]","{browseButton}":"[data-browse-avatar]"}},function(b,c){return{init:function(){b.state=!!b.options.hasAvatar},initErrorOpts:function(){var a=b.field().htmlData();c.error=a.error||{}},state:!0,hasAdjustedCropImage:!1,"{self} onRender":function(){b.initErrorOpts()},toggleLoader:function(){isLoading=b.browseButton().hasClass("is-loading"),b.browseButton().toggleClass("is-loading",!isLoading)},"{file} change":function(c){function f(){EasySocial.ajax("fields/"+b.options.group+"/avatar/upload",{id:b.options.id,categoryId:b.options.categoryId,files:c},{type:"iframe"}).done(function(a,c,d){b.avatarName().val(a),b.avatarSource().val(c),b.avatarPath().val(d),b.avatarType().val("upload"),b.setLayout(c),b.galleryItem().removeClass("active"),b.removeFrame().hide(),b.revertFrame().hide(),b.state=!0}).fail(function(a){b.toggleLoader(),b.raiseError(a),b.file().show()})}if(!a.isEmpty(c.val())){var e=c.val().replace(/\\/g,"/").replace(/.*\//,"");if(c.parents(".input-group").find(":text").val(e),b.state=!1,b.toggleLoader(),b.frame().hide(),b.file().hide(),b.clearError(),b.options.newRegistration)f();else{var g=[],h=0;g.push(c.get(0).files[0].size),h=c.get(0).files[0].size,EasySocial.ajax("site/controllers/photos/checkFileSize",{filesize:g,totalsize:h,uid:b.options.id,utype:b.options.group}).done(function(){f()}).fail(function(a){b.toggleLoader(),b.raiseError(a),b.file().show()})}}},setLayout:function(c){var d=a.Image.get(c),e=b.frame();d.done(function(d,f){e.css("background-image",a.cssUrl(c)),e.addClass("avatar-frame-crop"),e.show(),b.toggleLoader(),b.actions().show(),b.note().show(),b.viewport().imgAreaSelect({remove:!0}),b.viewport().show();var g=a.Image.resizeWithin(f.width,f.height,e.width(),e.height()),h=Math.min(g.width,g.height),i=Math.floor((g.width-h)/2),j=Math.floor((g.height-h)/2),k=i+h,l=j+h;b.viewport().css(g).imgAreaSelect({handles:!0,aspectRatio:"1:1",parent:e,x1:i,y1:j,x2:k,y2:l,onSelectEnd:function(a,c){var d=!("0"==c.width&&"0"==c.height);if(d){var e=JSON.stringify(b.data());b.avatarData().val(e),b.hasAdjustedCropImage=!0}}})})},"{cancel} click":function(){b.actions().hide(),b.note().hide(),b.frame().hide(),b.file().show(),b.file().val(""),b.file().parents(".input-group").find(":text").val(""),b.avatarSource().val(""),b.avatarPath().val(""),b.avatarData().val(""),b.avatarType().val(""),b.viewport().hide().imgAreaSelect({remove:!0}),a.isEmpty(b.options.origSource)||b.frame().css("background-image",a.cssUrl(b.options.origSource)).removeClass("avatar-frame-crop").show(),b.options.hasAvatar&&b.removeFrame().show()},data:function(){var a=b.viewport(),c=a.width(),d=a.height(),e=a.imgAreaSelect({instance:!0}).getSelection(),f={top:e.y1/d,left:e.x1/c,width:e.width/c,height:e.height/d};return f},"{gallery} click":function(){b.galleryList().toggle()},"{galleryItem} click":function(a){if(!a.hasClass("active")){var d=a.data("id");b.galleryItem().removeClass("active"),a.addClass("active"),b.state=!1,b.toggleLoader(),b.frame().hide(),b.file().hide(),b.file().val(""),b.file().parents(".input-group").find(":text").val(""),b.clearError(),b.avatarType().val("gallery"),b.avatarSource().val(d),EasySocial.ajax("fields/user/avatar/loadDefault",{avatarId:d}).done(function(a){b.frame().css("background-image","url("+a+")"),b.frame().show(),b.frame().removeClass("avatar-frame-crop"),b.toggleLoader(),b.viewport().hide(),b.viewport().imgAreaSelect({remove:!0}),b.actions().hide(),b.note().hide(),b.file().show(),b.revertFrame().show(),b.removeFrame().hide(),b.state=!0})}},"{remove} click":function(){b.avatarType().val("remove"),b.frame().css("background-image",a.cssUrl(b.options.defaultAvatar)),b.removeFrame().hide(),b.options.hasAvatar&&b.revertFrame().show(),b.state=!1},"{revert} click":function(){b.avatarType().val(""),b.frame().css("background-image",a.cssUrl(b.options.origSource)),b.options.hasAvatar&&b.removeFrame().show(),b.revertFrame().hide(),b.galleryItem().removeClass("active"),b.state=!0},"{self} onSubmit":function(a,d,e){if(b.options.required&&(b.state||(c.error||b.initErrorOpts(),b.raiseError(c.error.empty)),e.push(b.state)),!b.hasAdjustedCropImage){var f=b.data(),g=JSON.stringify(f);b.avatarData().val(g)}},raiseError:function(a){b.trigger("error",[a])},clearError:function(){b.trigger("clear")}}}),b.resolve()})});