EasySocial.module("apps/fields/user/address/osm",function(a){var b=this;a.template("easysocial/maps.suggestion",'<div class="es-location-suggestion" data-location-suggestion><span class="formatted_address">[%= location.formatted_address %]</span></div>'),EasySocial.require().library("leaflet","image").done(function(){var c={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};EasySocial.Controller("Field.Address.Osm",{defaultOptions:{required:!1,mapElementId:"map",staticMap:!1,"{field}":"[data-field-address]","{base}":"[data-location-base]","{map}":"[data-location-map]","{mapImage}":"[data-location-map-image]","{detectButton}":"[data-location-detect]","{removeButton}":"[data-location-remove]","{form}":"[data-location-form]","{textbox}":"[data-location-textbox]","{textField}":"[data-location-textfield]","{autocomplete}":"[data-location-autocomplete]","{suggestions}":"[data-location-suggestions]","{suggestion}":"[data-location-suggestion]","{source}":"[data-location-source]",view:{suggestion:"maps.suggestion"},marker:{}}},function(b,d){return{init:function(){b.options.mapElementId&&(b.mapElementId=b.options.mapElementId);var c=b.field().htmlData();d.error=c.error||{},navigator.geolocation&&window.es.isHttps&&(b.base().addClass("is-detectable"),b.detectButton().show()),b.textField().removeAttr("disabled");var e=b.field().is(":hidden");if(!a.isEmpty(b.source().val())&&!e){var c=JSON.parse(b.source().val());c.latitude&&c.longitude&&(lat=c.latitude,lng=c.longitude,b.initMap(),b.navigate(lat,lng),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"))}},initMap:function(){function a(a){var c=a.latlng;b.osm.removeLayer(b.marker),b.marker=L.marker(c).addTo(b.osm),b.osm.setView(c),b.lookupLatLng(c)}d.staticMap||void 0===b.osm&&(b.osm=L.map(b.mapElementId,{zoom:12}),b.osm.fitWorld(),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(b.osm),b.textField().removeAttr("disabled"),b.osm.on("click",a))},marker:{},updateField:function(a){b.textField().val(a[0].formatted_address),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"),b.result=a[0];var c=b.getResult("source");b.source().val(JSON.stringify(c))},"{window} resize":a.debounce(function(){var a=JSON.parse(b.source().val());if(a.latitude&&a.longitude){var c=b.mapImage();c.data("width")!==c.width()&&b.navigate(a.latitude,a.longitude)}},250),"{self} onShow":function(){var a=JSON.parse(b.source().val());if(a.latitude&&a.longitude&&void 0===b.osm){var c=b.mapImage();c.data("width")!==c.width()&&(b.initMap(),b.navigate(a.latitude,a.longitude),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"))}},navigate:function(a,c){d.staticMap?b.navigateStatic(a,c):b.navigateDynamic(a,c)},navigateStatic:function(c,d){b.field().css({"max-width":"none"});var e="//maps.wikimedia.org/img/osm-intl,13,"+c+","+d+",600x300.png",f=b.mapImage();a.Image.get(e).done(function(){f.css({backgroundImage:a.cssUrl(e),backgroundSize:"cover",backgroundPosition:"center center"}),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")}).always(function(){b.base().removeClass("is-loading")})},navigateDynamic:function(a,c){b.detectButton().addClass("t-hidden"),b.field().css({"max-width":"none"});var d={lat:parseFloat(a),lng:parseFloat(c)};b.osm.removeLayer(b.marker),b.osm.flyTo(d,10,{duration:3}),b.marker=L.marker(d).addTo(b.osm)},locations:{},lastQueryAddress:null,results:[],result:null,"{textField} keypress":function(d,e){switch(e.keyCode){case c.UP:var f=a(b.suggestion(".active").prev(b.suggestion.selector)[0]||b.suggestion(":last")[0]);b.suggestion().removeClass("active"),f.addClass("active").trigger("activate"),b.suggestions().scrollTo(f,{offset:-1*f.height()}),e.preventDefault();break;case c.DOWN:var g=a(b.suggestion(".active").next(b.suggestion.selector)[0]||b.suggestion(":first")[0]);b.suggestion().removeClass("active"),g.addClass("active").trigger("activate"),b.suggestions().scrollTo(g,{offset:-1*g.height()}),e.preventDefault();break;case c.ENTER:var h=b.suggestion(".active"),i=h.data("location");void 0!==i&&b.set(i),b.hideSuggestions();break;case c.ESCAPE:b.hideSuggestions()}},"{textField} keyup":function(d,e){switch(e.keyCode){case c.UP:case c.DOWN:case c.LEFT:case c.RIGHT:case c.ENTER:case c.ESCAPE:break;default:var f=a.trim(d.val());""===f&&(b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty"),b.hideSuggestions());var g=b.locations[f];g?(b.lastQueryAddress=f,b.suggest(g)):b.lookup(f)}},lookupLatLng:a.debounce(function(a){b.base().addClass("is-loading"),EasySocial.ajax("site/controllers/location/getLocations",{latitude:a.lat,longitude:a.lng}).done(function(a){b.base().removeClass("is-loading"),b.updateField(a)})},250),lookup:a.debounce(function(a){b.detectButton().addClass("is-loading"),b.base().addClass("is-loading"),EasySocial.ajax("site/controllers/location/getLocations",{query:a}).done(function(c){b.locations[a]=c,b.suggest(c),b.lastQueryAddress=a})},250),suggest:function(c){var d=b.suggestions();d.empty(),c.length<0||(b.results=c,a.each(c,function(a,c){c.formatted_address=c.formatted_address,b.view.suggestion({location:c}).data("location",c).appendTo(d)}),b.showSuggestions(),b.base().removeClass("is-loading"))},showSuggestions:function(){b.focusSuggestion=!0,b.element.find(".es-story-footer").addClass("swap-zindex"),setTimeout(function(){b.autocomplete().addClass("active");var c=a(document),d="click.es.story.location";c.off(d).on(d,function(e){var f=a(e.target).parents().andSelf();f.filter(b.element).length>0||(c.off(d),b.hideSuggestions())})},500)},hideSuggestions:function(){b.focusSuggestion=!1,b.autocomplete().removeClass("active"),a(document).off("click.es.story.location"),setTimeout(function(){b.focusSuggestion||b.element.find(".es-story-footer").removeClass("swap-zindex")},500)},"{suggestion} activate":function(a){b.initMap();var d=a.data("location"),e=d.latitude,f=d.longitude;b.navigate(e,f)},"{suggestion} mouseover":function(a){b.suggestion().removeClass("active"),a.addClass("active").trigger("activate")},"{suggestion} click":function(a){b.initMap();var d=a.data("location");b.set(d),b.hideSuggestions(),b.validateInput()},set:function(a){b.currentLocation=a;var e=(a.latitude,a.longitude,a.formatted_address);b.textField().val(e),b.lastQueryAddress=e,b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"),b.result=a;var f=b.getResult("source");b.source().val(JSON.stringify(f))},unset:function(){b.osm.removeLayer(b.marker),b.currentLocation=null,b.textField().val(""),b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty"),b.source().val("")},detectTimer:null,"{detectButton} click":function(){b.textbox();b.detectButton().addClass("is-loading"),clearTimeout(b.detectTimer),b.detectTimer=setTimeout(function(){b.detectButton().removeClass("is-loading"),navigator.geolocation.getCurrentPosition(function(a){var c=a.coords;lat=c.latitude,lng=c.longitude,b.initMap(),b.navigate(lat,lng),b.lookupLatLng({lat:lat,lng:lng})})},2e3)},raiseError:function(a){b.trigger("error",[a])},clearError:function(){b.trigger("clear")},validateInput:function(){if(b.clearError(),a.isEmpty(b.source().val())&&d.required)return b.raiseError(d.error.maps),!1;var c=b.source().val();if(c){var e=JSON.parse(c);if((!e.latitude||!e.longitude)&&d.required)return b.raiseError(d.error.maps),!1}return!0},"{self} onSubmit":function(a,c,d){d.push(b.validateInput())},"{removeButton} click":function(){b.unset(),b.hideSuggestions(),b.validateInput()},getResult:function(c){if(!b.result){if(0===b.results.length)return!1;b.result=b.results[0]}var d=b.result;if(void 0===c)return d;switch(c){case"coords":return{lat:d.latitude,lng:d.longitude};case"lat":case"latitude":return d.latitude;case"lng":case"longitude":return d.longitude;case"address":return d.formatted_address;case"source":var e={};a.each(d.address,function(a,b){e[a]=b});var f={address1:["house_number","mall","route","building","public_building"],address2:["road","neighborhood","premise","subpremise"],city:["city","suburb","village"],state:"state",zip:"postcode",country:"country"},g={};a.each(f,function(b,c){return g[b]="",a.isArray(c)?(a.each(c,function(a,c){return void 0!==e[c]?(g[b]=e[c],!1):!0}),!0):(void 0!==e[c]&&(g[b]=e[c]),void 0)});var h=a.extend(g,{components:e,address:d.formatted_address,latitude:d.latitude,longitude:d.longitude});return h}}}}),b.resolve()})});