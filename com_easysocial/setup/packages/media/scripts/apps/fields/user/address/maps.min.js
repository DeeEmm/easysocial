EasySocial.module("apps/fields/user/address/maps",function(a){var b=this;a.template("easysocial/maps.suggestion",'<div class="es-location-suggestion" data-location-suggestion><span class="formatted_address">[%= location.formatted_address %]</span></div>'),EasySocial.require().library("gmaps","image").done(function(){var c={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};EasySocial.Controller("Field.Address.Maps",{defaultOptions:{zoom:2,latitude:null,longitude:null,address:null,singleLocation:!0,staticMap:!1,required:!1,ratio:3,"{field}":"[data-field-address]","{base}":"[data-location-base]","{map}":"[data-location-map]","{mapImage}":"[data-location-map-image]","{detectButton}":"[data-location-detect]","{removeButton}":"[data-location-remove]","{form}":"[data-location-form]","{textbox}":"[data-location-textbox]","{textField}":"[data-location-textfield]","{autocomplete}":"[data-location-autocomplete]","{suggestions}":"[data-location-suggestions]","{suggestion}":"[data-location-suggestion]","{source}":"[data-location-source]",view:{suggestion:"maps.suggestion"}}},function(b,d){return{init:function(){var c=b.field().htmlData();if(d.error=c.error||{},navigator.geolocation&&b.base().addClass("is-detectable"),b.textField().removeAttr("disabled"),!a.isEmpty(b.source().val())){var c=JSON.parse(b.source().val());c.latitude&&c.longitude&&(d.staticMap?b.navigate(c.latitude,c.longitude):b.navigateDynamic(c.latitude,c.longitude),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"))}},renderDynamicMap:function(c,d){"undefined"==typeof gmap?gmap=new a.GMaps({div:"#map",lat:c,lng:d,zoom:15,mapTypeId:"roadmap",zoomControl:!0,clickableIcons:!1,streetViewControl:!1,mapTypeControl:!1}):gmap.setCenter(c,d),gmap.addListener("click",function(a){var c=a.latLng;b.populateMarker(c.lat(),c.lng(),"addmarker")})},populateMarker:function(a,c,d){gmap.removeMarkers();var e=gmap.addMarker({lat:a,lng:c});gmap.setCenter(a,c);var f=gmap.map.zoom;13>f&&(gmap.fitZoom(),gmap.zoomOut(9)),"addmarker"==d&&b.processMarker(e)},processMarker:function(a){markerLat=a.getPosition().lat(),markerLng=a.getPosition().lng();var d={lat:markerLat,lng:markerLng};b.lookupLatLng(d)},updateField:function(a,c){b.textField().val(a.name),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"),b.result=c;var d=b.getResult("source");b.source().val(JSON.stringify(d))},"{window} resize":a.debounce(function(){var a=JSON.parse(b.source().val());if(a.latitude&&a.longitude){var c=b.mapImage();c.data("width")!==c.width()&&b.navigate(a.latitude,a.longitude)}},250),"{self} onShow":function(){var a=JSON.parse(b.source().val());if(a.latitude&&a.longitude){var c=b.mapImage();c.data("width")!==c.width()&&b.navigate(a.latitude,a.longitude)}},navigateDynamic:function(a,c){b.renderDynamicMap(a,c),b.populateMarker(a,c)},navigate:function(c,d){b.field().css({"max-width":"none"});var e=b.mapImage(),f=window.es.gmapsApiKey,i=(Math.floor(e.width()),Math.floor(e.height()),a.GMaps.staticMapURL({key:f,size:[1280,1280],lat:c,lng:d,sensor:!0,scale:2,markers:[{lat:c,lng:d}]}));a.Image.get(i).done(function(){e.css({backgroundImage:a.cssUrl(i),backgroundSize:"cover",backgroundPosition:"center center"}),b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")}).always(function(){b.base().removeClass("is-loading")})},locations:{},lastQueryAddress:null,results:[],result:null,"{textField} keypress":function(d,e){switch(e.keyCode){case c.UP:var f=a(b.suggestion(".active").prev(b.suggestion.selector)[0]||b.suggestion(":last")[0]);b.suggestion().removeClass("active"),f.addClass("active").trigger("activate"),b.suggestions().scrollTo(f,{offset:-1*f.height()}),e.preventDefault();break;case c.DOWN:var g=a(b.suggestion(".active").next(b.suggestion.selector)[0]||b.suggestion(":first")[0]);b.suggestion().removeClass("active"),g.addClass("active").trigger("activate"),b.suggestions().scrollTo(g,{offset:-1*g.height()}),e.preventDefault();break;case c.ENTER:var h=b.suggestion(".active"),i=h.data("location");b.set(i),b.hideSuggestions();break;case c.ESCAPE:b.hideSuggestions()}},"{textField} keyup":function(d,e){switch(e.keyCode){case c.UP:case c.DOWN:case c.LEFT:case c.RIGHT:case c.ENTER:case c.ESCAPE:break;default:var f=a.trim(d.val());""===f&&(b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty"),b.hideSuggestions());var g=b.locations[f];g?(b.lastQueryAddress=f,b.suggest(g)):b.lookup(f)}},lookupLatLng:a.debounce(function(c){b.base().addClass("is-loading"),a.GMaps.geocode({lat:c.lat,lng:c.lng,callback:function(a,d){b.base().removeClass("is-loading"),"OK"==d&&(c.name=a[0].formatted_address,b.updateField(c,a[0]))}})},250),lookup:a.debounce(function(c){b.detectButton().addClass("is-loading"),a.GMaps.geocode({address:c,callback:function(a,d){b.detectButton().removeClass("is-loading"),"OK"==d&&(b.locations[c]=a,b.suggest(a),b.lastQueryAddress=c)}})},250),suggest:function(c){var d=b.suggestions();d.empty(),c.length<0||(b.results=c,a.each(c,function(a,c){b.view.suggestion({location:c}).data("location",c).appendTo(d)}),b.showSuggestions())},showSuggestions:function(){b.focusSuggestion=!0,b.element.find(".es-story-footer").addClass("swap-zindex"),setTimeout(function(){b.autocomplete().addClass("active");var c=a(document),d="click.es.story.location";c.off(d).on(d,function(e){var f=a(e.target).parents().andSelf();f.filter(b.element).length>0||(c.off(d),b.hideSuggestions())})},500)},hideSuggestions:function(){b.focusSuggestion=!1,b.autocomplete().removeClass("active"),a(document).off("click.es.story.location"),setTimeout(function(){b.focusSuggestion||b.element.find(".es-story-footer").removeClass("swap-zindex")},500)},"{suggestion} activate":function(a){var e=a.data("location"),f=e.geometry.location.lat(),g=e.geometry.location.lng();d.staticMap?b.navigate(f,g):b.navigateDynamic(f,g)},"{suggestion} mouseover":function(a){b.suggestion().removeClass("active"),a.addClass("active").trigger("activate")},"{suggestion} click":function(a){var d=a.data("location");b.set(d),b.hideSuggestions(),b.validateInput()},set:function(a){b.currentLocation=a;var e=(a.geometry.location.lat(),a.geometry.location.lng(),a.formatted_address);b.textField().val(e),b.lastQueryAddress=e,b.base().addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data"),b.result=a;var f=b.getResult("source");b.source().val(JSON.stringify(f))},unset:function(){gmap.removeMarkers(),b.currentLocation=null,b.textField().val(""),b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty"),b.source().val("")},detectTimer:null,"{detectButton} click":function(){b.textbox();b.detectButton().addClass("is-loading"),clearTimeout(b.detectTimer),b.detectTimer=setTimeout(function(){b.detectButton().removeClass("is-loading")},8e3),a.GMaps.geolocate({success:function(c){a.GMaps.geocode({lat:c.coords.latitude,lng:c.coords.longitude,callback:function(a,c){"OK"==c&&(b.suggest(a),b.textField().focus())}})},error:function(a){var b="";switch(a.code){case 1:b=d.error.map.permission;break;case 2:b=d.error.map.timeout;break;case 3:default:b=d.error.map.unavailable}},always:function(){clearTimeout(b.detectTimer),b.detectButton().removeClass("is-loading")}})},raiseError:function(a){b.trigger("error",[a])},clearError:function(){b.trigger("clear")},validateInput:function(){if(b.clearError(),a.isEmpty(b.source().val())&&d.required)return b.raiseError(d.error.maps),!1;var c=b.source().val();if(c){var e=JSON.parse(c);if((!e.latitude||!e.longitude)&&d.required)return b.raiseError(d.error.maps),!1}return!0},"{self} onSubmit":function(a,c,d){d.push(b.validateInput())},"{removeButton} click":function(){b.unset(),b.hideSuggestions(),b.validateInput()},getResult:function(c){if(!b.result){if(0===b.results.length)return!1;b.result=b.results[0]}var d=b.result;if(void 0===c)return d;switch(c){case"coords":return{lat:d.geometry.location.lat(),lng:d.geometry.location.lng()};case"lat":case"latitude":return d.geometry.location.lat();case"lng":case"longitude":return d.geometry.location.lng();case"address":return d.formatted_address;case"viewport":return d.geometry.viewport;case"bounds":return d.geometry.bounds||d.geometry.viewport;case"source":var e={};a.each(d.address_components,function(a,b){b.types[0]&&(e[b.types[0]]=b.long_name)});var f={address1:["street_address","route"],address2:["intersection","colloquial_area","neighborhood","premise","subpremise"],city:["locality","sublocality","sublocality_level_1","sublocality_level_2","sublocality_level_3","sublocality_level_4","sublocality_level_5"],state:["administrative_area_level_1","administrative_area_level_2","administrative_area_level_3"],zip:"postal_code",country:"country"},g={};a.each(f,function(b,c){return g[b]="",a.isArray(c)?(a.each(c,function(a,c){return void 0!==e[c]?(g[b]=e[c],!1):!0}),!0):(void 0!==e[c]&&(g[b]=e[c]),void 0)});var h=a.extend(g,{components:e,address:d.formatted_address,latitude:d.geometry.location.lat(),longitude:d.geometry.location.lng()});return h}}}}),b.resolve()})});