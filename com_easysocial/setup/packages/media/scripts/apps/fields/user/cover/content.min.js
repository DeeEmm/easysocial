EasySocial.module("apps/fields/user/cover/content",function(a){var b=this;EasySocial.require().library("image").done(function(){EasySocial.Controller("Field.Cover",{defaultOptions:{id:0,group:null,required:!1,hasCover:!0,defaultCover:null,categoryId:0,ratio:3,"{field}":"[data-field-cover]","{image}":"[data-field-cover-image]","{data}":"[data-field-cover-data]","{position}":"[data-field-cover-position]","{file}":"[data-field-cover-file]","{note}":"[data-field-cover-note]","{error}":"[data-field-error]","{removeButton}":"[data-field-cover-remove-button]","{browseButton}":"[data-browse-cover]","{revertFrame}":"[data-field-cover-revert]","{revertButton}":"[data-field-cover-revert-button]"}},function(b,c){return{init:function(){b.setFrame(),b.setLayout(),b.origCover=b.options.hasCover?a.uri(b.image().css("backgroundImage")).extract(0):null,b.origPosition=b.options.hasCover?b.image().css("backgroundPosition"):null,b.state=!!b.options.hasCover},initErrorOpts:function(){var a=b.field().htmlData();c.error=a.error||{}},state:!0,"{self} onRender":function(){b.initErrorOpts()},"{self} onShow":function(){setTimeout(function(){b.setLayout()},1)},setFrame:function(){var a=b.image().width(),c=a/b.options.ratio;b.image().css("height",c)},"{window} resize":a.debounce(function(){b.setFrame()},250),imageLoaders:{},toggleLoader:function(){isLoading=b.browseButton().hasClass("is-loading"),b.browseButton().toggleClass("is-loading",!isLoading)},"{file} change":function(c){function f(){EasySocial.ajax("fields/"+b.options.group+"/cover/upload",{id:b.options.id,categoryId:b.options.categoryId,files:c},{type:"iframe"}).done(function(c){var d=JSON.stringify(c);b.data().val(d);var e=JSON.stringify({x:.5,y:.5});b.position().val(e),b.position().val();{var f=c.large.uri,g=b.imageLoaders;(g[f]||(g[f]=a.Image.get(f))).done(function(a){b.setLayout.image=a,b.file().show(),b.image().show(),b.note().show(),b.toggleLoader(),b.revertFrame().hide(),b.removeButton().show(),b.setCover(c.large.uri)})}b.state=!0}).fail(function(a){b.toggleLoader(),b.file().show(),b.error().show().html(a)})}if(!a.isEmpty(c.val())){var e=c.val().replace(/\\/g,"/").replace(/.*\//,"");if(c.parents(".input-group").find(":text").val(e),b.state=!1,b.toggleLoader(),b.error().hide(),b.image().hide(),b.note().hide(),b.file().hide(),b.options.newRegistration)f();else{var g=[],h=0;g.push(c.get(0).files[0].size),h=c.get(0).files[0].size,EasySocial.ajax("site/controllers/photos/checkFileSize",{filesize:g,totalsize:h,uid:b.options.id,utype:b.options.group}).done(function(){f()}).fail(function(a){b.toggleLoader(),b.file().show(),b.error().show().html(a)})}}},setLayout:function(){var c=b.image(),d=b.setLayout.image;if(d){var h=d.data("width"),i=d.data("height"),j=c.width(),k=c.height(),l=a.Image.resizeProportionate(h,i,j,k,"outer");b.availableWidth=j-l.width,b.availableHeight=k-l.height,b.setFrame()}else{var e=a.uri(c.css("backgroundImage")).extract(0);if(!e)return;{var f=b.imageLoaders;(f[e]||(f[e]=a.Image.get(e))).done(function(a){b.setLayout.image=a,b.setLayout()})}}},setCover:function(c,d){d=d||"50% 50%",b.image().css({backgroundImage:a.cssUrl(c),backgroundPosition:d}),b.setLayout(),b.image().addClass("cover-move"),b.note().show()},x:.5,y:.5,moveCover:function(a,c,d){d||(d=b.image());var e=b.availableWidth,f=b.availableHeight,g=0==e?0:b.x+(a/e||0),h=0==f?0:b.y+(c/f||0);0>g&&(g=0),g>1&&(g=1),0>h&&(h=0),h>1&&(h=1),d.css("backgroundPosition",100*(b.x=g)+"% "+100*(b.y=h)+"% ");var i={x:b.x,y:b.y};b.position().val(JSON.stringify(i))},"{image} mousedown":function(c,d){d.target===b.image()[0]&&d.preventDefault();var e=b.image(),f=e.css("backgroundPosition").split(" ");b.x=parseInt(f[0])/100,b.y=parseInt(f[1])/100;var g=d.pageX,h=d.pageY;a(document).on("mousemove.movingCover mouseup.movingCover",function(a){b.moveCover(-1*(g-(g=a.pageX)),-1*(h-(h=a.pageY)),e)}).on("mouseup.movingCover",function(){a(document).off("mousemove.movingCover mouseup.movingCover")})},"{removeButton} click":function(c){var d=b.data().val();a.isEmpty(d)?b.options.hasCover&&(b.setCover(b.options.defaultCover),b.data().val("delete"),c.hide(),b.revertFrame().show()):(b.origData=d,b.origPosition=b.position().val(),b.data().val(""),b.position().val(""),b.file().val(""),b.file().parents(".input-group").find(":text").val(""),b.options.hasCover?b.setCover(b.origCover):(b.setCover(b.options.defaultCover),b.data().val("delete"),c.hide())),b.state=!1},"{revertButton} click":function(){b.setCover(b.origCover,b.origPosition),b.revertFrame().hide(),b.removeButton().show(),b.data().val(""),b.position().val(""),b.file().val(""),b.file().parents(".input-group").find(":text").val(""),b.state=!0},"{self} onSubmit":function(d,e,f){var g=b.data().val(),h=b.options.hasCover;if("delete"==g)var g="",h=!1;b.options.required&&!h&&a.isEmpty(g)&&(b.state||(c.error||b.initErrorOpts(),b.raiseError(c.error.empty)),f.push(b.state))},raiseError:function(a){b.trigger("error",[a])}}}),b.resolve()})});