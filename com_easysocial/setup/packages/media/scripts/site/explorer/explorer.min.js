EasySocial.module("site/explorer/explorer",function(a){var b=this,c="is-selected",d=".is-selected",f=".is-checked",g=":not(.is-selected)",h="is-active",i=".is-active",j="fileSelect",k="fileDeselect",l="folderActivate",m="folderDeactivate",n="fileInsert",o="folderInsert",p="fileRemove",q="folderRemove",r="fileUse",s="serviceRequest";a.template("explorer/folder",'<div class="fd-explorer-folder" data-id="[%== data.id %]"><i class="fa fa-folder"></i> [%== data.name %]<a href="javascript: void(0);" class="fd-folder-remove-button" data-fd-explorer-delete-folder-button><i class="fa fa-times"></i></a></div>'),a.template("explorer/fileGroup",'<div class="fd-explorer-file-group" data-folder="[%== data.id %]" data-plupload-dropsite></div>'),a.template("explorer/file",'<div class="fd-explorer-file" data-id="[%== data.id %]">[%== data.name %]</div>'),EasySocial.require().script("site/explorer/uploader").done(),a.Controller("Explorer",{pluginName:"explorer",hostname:"explorer",defaultOptions:{view:{folder:"explorer/folder",fileGroup:"explorer/fileGroup",file:"explorer/file"},layout:{fileItemHeight:52},isMobile:null,allowedUpload:!1,uid:null,type:null,disableValidation:!1,mockError:!1,controllerName:null,allowedExtensions:null,"{browser}":".fd-explorer-browser","{viewport}":".fd-explorer-viewport","{folderGroup}":"[data-explorer-folder-group]","{folder}":".fd-explorer-folder","{fileGroup}":".fd-explorer-file-group","{file}":".fd-explorer-file","{button}":"[data-fd-explorer-button]","{mockError}":"[name=mock_error]","{disableValidation}":"[name=disable_validation]","{fileInput}":"[name=file]","{logs}":"[data-alertlog]","{togglefunky}":".togglefunky","{funky}":".fd-explorer-funky","{serviceState}":".service-state","{backButton}":"[data-es-explorer-back]","{selectAllCheckbox}":"[data-fd-explorer-select-all]","{selectCheckbox}":"[data-fd-explorer-select]","{previewButton}":"[data-fd-explorer-preview-button]","{deleteButton}":"[data-fd-explorer-delete-button]","{deleteFolderButton}":"[data-fd-explorer-delete-folder-button]"}},function(b,e,t){return{init:function(){b.options.type=b.element.data("type"),b.options.uid=b.element.data("uid"),b.options.controllerName=b.element.data("controller-name"),b.options.allowedExtensions=b.element.data("allowed-extensions"),a.module("easysocial/site/explorer/uploader").done(function(a){b.addPlugin("uploader",a,{settings:{filters:[{extensions:b.options.allowedExtensions}],allowedUpload:e.allowedUpload,uid:b.options.uid,type:b.options.type}})}),b.services.getFolders().done(function(a){b.insertFolder(a),e.isMobile||b.folder(":first").click()}),b.viewport().on("scroll",a.debounce(b.viewportScroll,250))},baseParams:function(){return{uid:t.data("uid"),type:t.data("type")}},exception:function(c){var d=b.logs();switch(a.isPlainObject(c)||(c={message:c,type:"error"}),c.type){case"error":d.switchClass("o-alert--error").html(c.message),EasySocial.debug&&console.error(c.message);break;case"warning":d.switchClass("o-alert--warning").html(c.message),EasySocial.debug&&console.warn(c.message);break;case"success":d.switchClass("o-alert--success").html(c.message),EasySocial.debug&&console.log(c.message);break;case"info":default:d.switchClass("o-alert--info").html(c.message),EasySocial.debug&&console.log(c.message)}return c},library:{file:{},folder:{}},data:function(a,c){return b.library[a][c]},addData:function(c,d){return a.isPlainObject(d)&&(d=[d]),a.isArray(d)?(a.each(d,function(d){a.isPlainObject(this)||b.exception("Skipping invalid "+c+" data at index "+d+"."),null===this.id&&(this.id=0),b.library[c][this.id]=this}),void 0):b.exception("Unable to add "+c+" to library due to invalid data given.")},removeData:function(a,c){delete b.library[a][c]},"{folder} click":function(a){b.activateFolder(a.data("id")),e.isMobile&&b.toggleSidebar()},"{backButton} click":function(){b.toggleSidebar()},toggleSidebar:function(){b.element.toggleClass("is-side-open")},currentFolder:function(){return b.folder(i).data("id")},activateFolder:function(a){var c=b.folder().filterBy("id",a),d=b.data("folder",a);c.length<1||(b.deactivateFolder(b.folder(i).data("id")),c.addClass(h),b.trigger(l,[a,c,d]))},deactivateFolder:function(a){var c=b.folder().filterBy("id",a),d=c.data("folder");c.length<1||(c.removeClass(h),b.trigger(m,[a,c,d]))},selectedFolder:function(){return b.currentFolder()},"{file} click":function(a,c){var d=c.metaKey||c.ctrlKey;d||b.deselectAllFiles(),b.toggleFile(a.data("id"))},toggleFile:function(a){var d=b.file().filterBy("id",a),e=d.hasClass(c)?"deselectFile":"selectFile";d.length<1||b[e](a)},selectFile:function(a){var d=b.file().filterBy("id",a),e=b.data("file",a);d.length<1||(d.addClass(c),b.trigger(j,[a,d,e]))},deselectFile:function(a){var d=b.file().filterBy("id",a),e=d.data("file",a);d.length<1||(d.removeClass(c),b.trigger(k,[a,d,e]))},selectAllFiles:function(){b.file(g).each(function(){b.selectFile(a(this).data("id"))})},deselectAllFiles:function(){b.file(d).each(function(){b.deselectFile(a(this).data("id"))})},selectedFile:function(){return b.selectedFiles()[0]},selectedFiles:function(){var e,c=[],e=b.file(f);return e.length<1&&(e=b.file(d)),e.each(function(){var b=a(this).data("id");c.push(b)}),c},insertFolder:function(c){a.isArray(c)||(c=[c]);var d=c[0];if(!a.isPlainObject(d))return b.exception("Invalid folder data given to be inserted into the folder group.");var e=b.folderGroup();if(e.length<1)return b.exception("Could not locate folder group element.");var f="";a.each(c,function(){null===this.id&&(this.id=0);var c=b.view.folder(!0,{data:this});this.deleteable||(c=a(c),c.find(b.deleteFolderButton.selector).addClass("t-hidden"),c=a("<div>").append(c).html()),f+=c}),f=a.buildHTML(f).appendTo(e),b.trigger(o,[f,c])},prependFile:function(c){if(!a.isPlainObject(c))return b.exception("Invalid file data given to be inserted.");var d=b.fileGroup().filterBy("folder",c.folder);if(d.length<1)return b.exception("Could not locate file group element for folder id "+c.folder+".");var e=c.html||b.view.file(!0,{data:c});if(a.buildHTML(e).data("finalized",!0).prependTo(d),d.data("folder")>0){var f=b.fileGroup().filterBy("folder",0);a.buildHTML(e).data("finalized",!0).prependTo(f)}},insertFile:function(c,d){if(a.isArray(c)||(c=[c]),void 0===d){var e=c[0];if(!a.isPlainObject(e))return b.exception("Invalid file data given to be inserted.");d=e.folder}var f=b.fileGroup().filterBy("folder",d);if(f.length<1)return b.exception("Could not locate file group element for folder id "+c.folder+".");var g=[];a.each(c,function(){var c=this;b.file().filterBy("id",this.id).each(function(){var d=a(this);if(!d.data("finalized")){var e=a.buildHTML(c.html||b.view.file(!0,{data:c})).data("finalized",!0);d.replaceWith(e)}})}),b.trigger(n,[g,c])},removeFolder:function(a){var d,c=b.folder().filterBy("id",a);c.length<1&&(d=b.exception("Could not locate to remove folder element for folder id "+a+".")),c.remove();var e=b.fileGroup().filterBy("folder",a);e.length<1&&(d=b.exception("Could not locate to remove file group element for folder id "+a+".")),e.remove(),b.trigger(q,[a,d])},removeFile:function(a){var d,c=b.file().filterBy("id",a);c.length<1&&(d=b.exception("Could not locate to remove file element for file id "+a+".")),c.remove(),b.trigger(p,[a,d])},service:function(c,d,f){b.serviceState().switchClass("state-busy");var g=EasySocial.ajax(t.data("url"),a.extend({hook:c,error:e.mockError},d),f).always(function(){b.serviceState().switchClass("state-idle")}).fail(function(a){b.exception(a)});return b.trigger(s,[c,g,d]),g},"{button} click":function(a){var c=a.attr("data-fd-explorer-button"),d=b.services[c];d&&d()},services:{getFolders:function(c){var d={start:0,limit:100},e=b.service("getFolders",a.extend(b.baseParams(),d,c)).done(function(a){b.addData("folder",a)});return e},addFolder:function(c){c||(c={name:prompt(e.languages.create)});var d={name:""};if(c=a.extend(b.baseParams(),d,c),!c.name&&!e.disableValidation)return b.exception({message:e.languages.invalid,type:"error"}),void 0;var f=b.service("addFolder",c).done(function(a){b.addData("folder",a),b.insertFolder(a)});return f},removeFolder:function(c){var d={id:b.selectedFolder()};if(!e.disableValidation&&void 0===b.selectedFolder())return b.exception("No folder selected"),void 0;var f=b.service("removeFolder",a.extend(b.baseParams(),d,c)).done(function(a){b.removeFolder(a)});return f},getFiles:function(c){var d={start:0,limit:100},e=b.service("getFiles",a.extend(b.baseParams(),d,c)).done(function(a){b.addData("file",a)});return e},addFile:function(c){var d={id:b.currentFolder(),files:b.fileInput()};if(!e.disableValidation&&!b.fileInput().val())return b.exception("No file chosen yet."),void 0;var f=b.service("addFile",a.extend(b.baseParams(),d,c),{type:"iframe"}).done(function(a){console.log("Upload returned data:",a),b.addData("file",a),b.prependFile(a),b.exception({message:"Added file "+a.name,type:"success"})});return f},removeFile:function(c){var d={id:b.selectedFiles()},c=a.extend(b.baseParams(),d,c);if(!e.disableValidation&&a.isArray(c.id)&&c.length<1)return b.exception("No file selected"),void 0;var f=b.service("removeFile",c).done(function(c){a.isArray(c)?a.each(c,function(){b.removeFile(this)}):b.removeFile(c),b.selectAllCheckbox().prop("checked",!1)});return f},useFile:function(){var c=b.selectedFiles(),d=[],e=[];a.each(c,function(){d.push(b.file().filterBy("id",this)),e.push(b.data("file",this))}),d.length<1||b.trigger(r,[c,d,e])},previewFile:function(a){if(!a)var c=b.selectedFile(),a=b.file().filterBy("id",c);var d=a.data("previewUri");d&&window.open(d,"_blank")}},"{self} folderActivate":function(a,c,d,e,f){var g=b.fileGroup(),i=g.filterBy("folder",d);if(g.removeClass(h),i.length<1){f.map||(f.map=[]);var j='<div class="fd-explorer-file" data-id="'+f.map.join('">&nbsp;</div><div class="fd-explorer-file" data-id="')+'">&nbsp;</div>';i=b.view.fileGroup({data:f}).html(j).appendTo(b.viewport()),b.services.getFiles({id:d}).done(function(a){b.insertFile(a,d)})}i.addClass("is-active")},viewportScroll:function(){var a=b.viewport()[0],e=(b.viewport().height(),a.scrollHeight,a.scrollTop),g=b.file(":nth(2)").outerHeight(!0),h=Math.floor(e/g),i=3,j=b.fileGroup(".is-active"),k=j.data("folder");b.services.getFiles({id:k,start:h-i}).done(function(a){b.insertFile(a,k)})},"{togglefunky} click":function(){b.funky().toggle()},"{disableValidation} change":function(a){e.disableValidation=!!a.prop("checked"),b.exception({message:"Client-side validation is "+(e.disableValidation?"OFF!":"ON!"),type:"info"})},"{mockError} change":function(a){e.mockError=!!a.prop("checked"),b.exception({message:"Error mocking is "+(e.mockError?"ON!":"OFF!"),type:"info"})},"{selectAllCheckbox} click":function(a){var c=a.prop("checked");b.fileGroup(i).find(b.selectCheckbox.selector).prop("checked",c).trigger("change")},"{selectCheckbox} change":function(a){var c=b.file.of(a),e=(c.data("id"),a.prop("checked"));c.toggleClass("is-checked",e)},"{previewButton} click":function(a,c){c.preventDefault(),c.stopPropagation();{var d=b.file.of(a);d.data("id")}b.services.previewFile(d)},"{deleteButton} click":function(a){var c=b.file.of(a),d=c.data("id");EasySocial.dialog({content:EasySocial.ajax("site/views/explorer/confirmDeleteFile",{id:d}),bindings:{"{deleteButton} click":function(){EasySocial.dialog().close(),b.services.removeFile({id:d})}}})},"{deleteFolderButton} click":function(a,c){c.preventDefault(),c.stopPropagation();var d=b.folder.of(a),e=d.data("id");0!==e&&EasySocial.dialog({content:EasySocial.ajax("site/views/explorer/confirmDeleteFolder",{id:e}),bindings:{"{deleteButton} click":function(){EasySocial.dialog().close(),b.services.removeFolder({id:e})}}})}}}),b.resolve()});