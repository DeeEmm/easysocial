EasySocial.module("site/story/gmaps",function(a){var b=this;EasySocial.require().library("gmaps","scrollTo","image").done(function(){var c={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};EasySocial.Controller("Story.Gmaps",{defaultOptions:{map:{lat:0,lng:0},staticMap:!0,"{base}":"[data-story-location]","{form}":"[data-story-location-form]","{textField}":"[data-story-location-textField]","{detectButton}":"[data-story-location-detect-button]","{autocomplete}":"[data-story-location-autocomplete]","{suggestions}":"[data-story-location-suggestions]","{suggestion}":"[data-story-location-suggestion]","{textbox}":"[data-story-location-textbox]","{removeButton}":"[data-story-location-remove-button]","{map}":"[data-story-location-map]","{mapImage}":"[data-story-location-map-image]","{meta}":"[data-story-meta-location]"}},function(b,d){return{init:function(){var a=b.options.currentLocation;navigator.geolocation&&b.base().addClass("is-detectable"),b.textField().removeAttr("disabled"),a&&(b.mapImage().width(458),b.mapImage().height(115),b.set(a))},"{window} resize":a.debounce(function(){var a=b.currentLocation;if(a){var c=b.mapImage();c.data("width")!==c.width()&&b.navigate(a.latitude,a.longitude)}},250),renderDynamicMap:function(c,d){"undefined"==typeof gmap?gmap=new a.GMaps({div:"#map",lat:c,lng:d,zoom:15,mapTypeId:"roadmap",zoomControl:!0,clickableIcons:!1,streetViewControl:!1,mapTypeControl:!1}):gmap.setCenter(c,d),gmap.addListener("click",function(a){var c=a.latLng;b.populateMarker(c.lat(),c.lng(),"addmarker")})},populateMarker:function(a,c,d){gmap.removeMarkers();var e=gmap.addMarker({lat:a,lng:c});gmap.setCenter(a,c);var f=gmap.map.zoom;13>f&&(gmap.fitZoom(),gmap.zoomOut(9)),"addmarker"==d&&b.processMarker(e)},processMarker:function(a){markerLat=a.getPosition().lat(),markerLng=a.getPosition().lng();var d={lat:markerLat,lng:markerLng};b.lookupLatLng(d)},updateField:function(c,d){b.textField().val(c.name);var e={latitude:c.lat,longitude:c.lng,fulladdress:d.formatted_address};b.currentLocation=e;var f=a.Deferred();f.resolve(e),f.done(function(a){EasySocial.ajax("site/views/location/getStoryCaption",{address:c.name}).done(function(a){b.story.setMeta("location",a)}),b.lastQueryAddress=a.fulladdress,b.base().removeClass("is-loading").addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")})},navigateDynamic:function(a,c){b.renderDynamicMap(a,c),b.populateMarker(a,c)},navigate:function(c,d){var e=window.es.gmapsApiKey,f=b.mapImage(),g=f.width(),h=f.height(),i=a.GMaps.staticMapURL({key:e,size:[g,h],lat:c,lng:d,sensor:!0,scale:2,markers:[{lat:c,lng:d}]});a.Image.get(i).done(function(){f.css({backgroundImage:a.cssUrl(i),backgroundSize:"cover",backgroundPosition:"center center"}),b.base().removeClass("is-loading").addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")})},locations:{},lastQueryAddress:null,"{textField} keydown":function(d,e){switch(e.keyCode){case c.UP:var f=a(b.suggestion(".active").prev(b.suggestion.selector)[0]||b.suggestion(":last")[0]);b.suggestion().removeClass("active"),f.addClass("active").trigger("activate"),b.suggestions().scrollTo(f,{offset:-1*f.height()}),e.preventDefault();break;case c.DOWN:var g=a(b.suggestion(".active").next(b.suggestion.selector)[0]||b.suggestion(":first")[0]);b.suggestion().removeClass("active"),g.addClass("active").trigger("activate"),b.suggestions().scrollTo(g,{offset:-1*g.height()}),e.preventDefault();break;case c.ENTER:var h=b.suggestion(".active"),i=h.data("location");b.set(i),b.hideSuggestions();break;case c.ESCAPE:b.hideSuggestions()}},"{textField} keyup":function(d,e){switch(e.keyCode){case c.UP:case c.DOWN:case c.LEFT:case c.RIGHT:case c.ENTER:case c.ESCAPE:break;default:var f=a.trim(d.val());""===f&&(b.base().removeClass("has-location"),b.hideSuggestions(),b.map().removeClass("has-data").addClass("is-empty"));var g=b.locations[f];g?(b.lastQueryAddress=f,b.suggest(g)):b.lookup(f)}},lookupLatLng:a.debounce(function(c){b.base().addClass("is-loading"),a.GMaps.geocode({lat:c.lat,lng:c.lng,callback:function(a,d){b.base().removeClass("is-loading"),"OK"==d&&(c.name=a[0].formatted_address,b.updateField(c,a[0]))}})},250),lookup:a.debounce(function(a){b.base().addClass("is-loading"),EasySocial.ajax("site/controllers/location/getLocations",{query:a}).done(function(c){b.base().removeClass("is-loading"),b.locations[a]=c,b.suggest(c),b.lastQueryAddress=a}).fail(function(){})},250),suggest:function(c){var d=b.suggestions();if(d.empty(),!(c.length<0)){var e=[];a.each(c,function(a,b){e.push(b.address)}),EasySocial.ajax("site/views/location/format",{locations:e}).done(function(b){a.each(b,function(b,e){a(e).data("location",c[b]).appendTo(d)})}),b.showSuggestions()}},showSuggestions:function(){b.focusSuggestion=!0,b.element.find(".es-story-footer").addClass("swap-zindex"),b.story.clearMessage(),setTimeout(function(){b.autocomplete().addClass("active");var c=a(document),d="click.es.story.location";c.off(d).on(d,function(e){var f=a(e.target).parents().andSelf();f.filter(b.element).length>0||(c.off(d),b.hideSuggestions())})},500)},hideSuggestions:function(){b.focusSuggestion=!1,b.autocomplete().removeClass("active"),a(document).off("click.es.story.location"),setTimeout(function(){b.focusSuggestion||b.element.find(".es-story-footer").removeClass("swap-zindex")},500)},"{suggestion} activate":function(a){var e=a.data("location"),f=e.latitude,g=e.longitude;d.staticMap?b.navigate(f,g):b.navigateDynamic(f,g)},"{suggestion} mouseover":function(a){b.suggestion().removeClass("active"),a.addClass("active").trigger("activate")},"{suggestion} click":function(a){var d=a.data("location");b.set(d),b.hideSuggestions()},set:function(c){b.currentLocation=c;var d=a.Deferred();a.isEmpty(c.fulladdress)?b.getAddress(c.latitude,c.longitude).done(function(a){c.fulladdress=c.name+", "+a,d.resolve(c)}):d.resolve(c),d.done(function(a){b.navigate(a.latitude,a.longitude),b.textField().val(a.fulladdress),b.lastQueryAddress=a.address,EasySocial.ajax("site/views/location/getStoryCaption",{address:a.fulladdress}).done(function(a){b.story.setMeta("location",a)}),b.base().removeClass("is-loading").addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")})},unset:function(){b.currentLocation=null,b.textField().val(""),b.story.removePanelCaption("locations"),b.mapImage().attr("src",""),b.story.setMeta("location",""),b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty")},activatePanel:function(){setTimeout(function(){b.textField().focus()},500)},deactivatePanel:function(){var a=b.currentLocation;a&&b.set(a)},detectTimer:null,"{detectButton} click":function(){{var c=b.story;b.textbox()}b.base().addClass("is-loading"),clearTimeout(b.detectTimer),b.detectTimer=setTimeout(function(){c.clearMessage(),EasySocial.ajax("site/views/location/getErrorMessage",{code:1}).done(function(a){c.setMessage(a),b.base().removeClass("is-loading")})},8e3),a.GMaps.geolocate({success:function(a){EasySocial.ajax("site/controllers/location/getLocations",{latitude:a.coords.latitude,longitude:a.coords.longitude}).done(function(a){b.suggest(a),b.textField().focus()}).fail(function(){})},error:function(a){c.clearMessage(),EasySocial.ajax("site/views/location/getErrorMessage",{code:a.code}).done(function(a){c.setMessage(a)})},always:function(){clearTimeout(b.detectTimer),b.base().removeClass("is-loading")}})},"{removeButton} click":function(){b.unset(),b.hideSuggestions()},"{meta} click":function(){b.story.activateMeta("location")},"{story} activateMeta":function(a,c,d){"location"===d.name&&setTimeout(function(){b.textField().focus()},1)},"{story} save":function(c,d,e){var f=b.currentLocation;if(f){var g=e.addTask("saveLocation");a.isEmpty(f.fulladdress)?b.getAddress(f.latitude,f.longitude).done(function(a){f.fulladdress=f.name+", "+a,b.save(g,f)}):b.save(g,f)}},getAddress:a.memoize(function(b,c){var d=a.Deferred(),e=new google.maps.Geocoder,f=new google.maps.LatLng(b,c);return e.geocode({latLng:f},function(a,b){b==google.maps.GeocoderStatus.OK&&d.resolve(a[0].formatted_address)}),d},function(a,b){return a+","+b}),save:function(a,b){a.save.data.locations_short_address=b.name,a.save.data.locations_lat=b.latitude,a.save.data.locations_lng=b.longitude,a.save.data.locations_formatted_address=b.fulladdress,a.save.data.locations_data=JSON.stringify(b),a.resolve()},"{story} clear":function(){b.unset(),b.hideSuggestions()}}}),b.resolve()})});