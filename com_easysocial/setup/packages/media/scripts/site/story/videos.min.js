EasySocial.module("site/story/videos",function(){var b=this;EasySocial.require().library("image","plupload").done(function(a){EasySocial.Controller("Story.Videos",{defaultOptions:{"{form}":"[data-video-form]","{panelButton}":'[data-story-plugin-name="videos"]',"{insertVideo}":"[data-insert-video]","{videoLink}":"[data-video-link]","{videoCategory}":"[data-video-category]","{uploaderForm}":"[data-video-uploader]","{uploaderButton}":"[data-video-uploader-button]","{uploaderDropsite}":"[data-video-uploader-dropsite]","{uploaderProgressBar}":"[data-video-uploader-progress-bar]","{uploaderProgressText}":"[data-video-uploader-progress-text]","{uploaderUploadBar}":"[data-video-uploader-upload-bar]","{uploaderUploadText}":"[data-video-uploader-upload-text]","{removeButton}":"[data-remove-video]","{previewImageWrapper}":"[data-video-preview-image]","{previewTitle}":"[data-video-preview-title]","{title}":"[data-video-title]","{previewDescription}":"[data-video-preview-description]","{description}":"[data-video-description]"}},function(b,c,d){return{init:function(){(0!=b.uploaderForm().length||0!=b.videoLink().length)&&(b.uploaderForm().length>0&&(b.uploader=b.uploaderForm().addController("plupload",a.extend({"{uploadButton}":b.uploaderButton.selector,"{uploadDropsite}":b.uploaderDropsite.selector},c.uploader)),b.plupload=b.uploader.plupload),c.isEdit&&(b.video={type:c.video.source,title:c.video.title,description:b.description().val(),link:c.video.link,id:c.video.id,isEncoding:c.video.isEncoding}))},renderDefaultPlaceholderDescription:!1,clickedRemoveButton:!1,isProcessed:function(){b.form().switchClass("is-processed"),b.processing=!1},isUploading:function(){b.form().switchClass("is-uploading")},isProcessing:function(){b.form().switchClass("is-processing"),b.processing=!0},isEncoding:function(){b.form().switchClass("is-encoding")},isInitial:function(){b.form().switchClass("is-waiting")},currentCategory:null,processing:!1,video:null,videoType:null,updatePreview:function(c,d,e){b.video={type:c,title:d.title,description:d.description,link:d.link,id:d.id?d.id:"",isEncoding:!1},title=b.title().attr("placeholder"),description=b.description().attr("placeholder"),""!=a.trim(d.title)&&(title=d.title,b.title().val(title)),""!=a.trim(d.description)&&(description=d.description,b.description().val(description),b.previewDescription().removeClass("no-description")),b.previewTitle().html(title),b.previewDescription().html(description),a.Image.get(e).done(function(a){a.appendTo(b.previewImageWrapper())})},resetProgress:function(){b.uploaderProgressBar().css("width","0%"),b.uploaderProgressText().html("0%")},clearForm:function(a){a&&(b.video=null),b.previewDescription().addClass("no-description"),b.isInitial(),b.videoLink().val(""),b.previewImageWrapper().empty(),b.previewTitle().empty(),b.title().val(""),b.previewDescription().empty(),b.description().val("")},editTitleEvent:"click.es.story.video.editLinkTitle",editDescriptionEvent:"click.es.story.video.editLinkDescription",editTitle:function(){b.form().addClass("editing-title"),setTimeout(function(){b.title().val(b.previewTitle().text()).focus()[0].select(),a(b.title()).on("change keyup paste",function(){b.saveTitle("apply")}),a(document).on(b.editTitleEvent,function(a){a.target!==b.title()[0]&&b.saveTitle("save")})},1)},saveTitle:function(c){c||(c="save");var d=b.title().val();return"apply"==c?(b.video.title=d,void 0):(d.length>0&&""!=a.trim(d)&&("save"==c&&b.previewTitle().html(d),b.video.title=d),b.form().removeClass("editing-title"),a(document).off(b.editTitleEvent),void 0)},checkVideoStatus:function(a,d){EasySocial.ajax("site/controllers/videos/status",{id:a,uid:c.video.uid,type:c.video.type,createStream:0,percentage:d,unpublished:1}).done(function(c,e,f,g){if("done"===e)return b.processing=!1,b.uploaderProgressBar().css("width","100%"),b.uploaderProgressText().html("100%"),b.isProcessed(),b.updatePreview("upload",f,g),b.resetProgress(),void 0;if("ignore"==e)return b.checkVideoStatus(a,d),void 0;var h=e+"%";b.uploaderProgressBar().css("width",h),b.uploaderProgressText().html(h),b.checkVideoStatus(a,e)})},editDescription:function(){b.form().addClass("editing-description"),setTimeout(function(){var d=b.previewDescription().clone(),e=d.hasClass("no-description");if(d.wrapInner(b.description()),c.isEdit&&e)b.description().val("").focus()[0].select();else if(e)b.description().val("").focus()[0].select();else{var f=b.previewDescription().html().replace(/\n/g,""),f=f.replace(/<br\s*[\/]?>/gi,"\n");b.description().val(f).focus()[0].select()}a(b.description()).on("change keyup paste",function(){b.saveDescription("apply")}),a(document).on(b.editDescriptionEvent,function(a){a.target!==b.description()[0]&&b.saveDescription("save")})},1)},saveDescription:function(c){if(b.video){c||(c="save");var d=b.description().val();switch(b.renderDefaultPlaceholderDescription=!1,c){case"save":var e=""===a.trim(d);b.previewDescription().toggleClass("no-description",e),e&&(d=b.description().attr("placeholder"),b.renderDefaultPlaceholderDescription=!0),d&&b.previewDescription().html(d.replace(/\n/g,"<br>")),b.video.description=d,b.form().find(".textareaClone").remove(),b.form().removeClass("editing-description"),a(document).off(b.editDescriptionEvent);break;case"apply":""===d&&(b.renderDefaultPlaceholderDescription=!0),b.video.description=d;case"revert":}}},"{window} easysocial.story.video.panel.insertvideolink":function(a,c,d){b.video||b.processing||!d||(b.panelButton().click(),b.clearForm(!0),b.videoLink().val(d),b.insertVideo().click(),b.story.activatePanel("videos"))},isExtensionAllowed:function(b,c){filename=b.name;var d=filename.substr(filename.lastIndexOf(".")+1);d=d.toLowerCase();var e=a.inArray(d,c);return e>=0?!0:!1},"{uploaderForm} FilesAdded":function(a,e,f,g){if(!b.isExtensionAllowed(g[0],f.settings.allowed))return b.clearMessage(),b.setMessage(c.errors.messages.invalid),b.clearForm(!0),!1;var h=d.find("[data-story-cluster]").val(),i=d.find("[data-story-clustertype]").val();EasySocial.ajax("site/controllers/videos/checkFileSize",{filesize:g[0].size,uid:h,utype:i}).done(function(){b.isUploading(),b.plupload.start()}).fail(function(a){b.clearMessage(),b.setMessage(a),b.clearForm(!0),b.plupload.removeFile(g[0])})},"{uploaderForm} UploadProgress":function(a,c,d,e){var f=e.percent+"%";b.uploaderUploadBar().css("width",f),b.uploaderUploadText().html(f)},"{uploaderForm} FileUploaded":function(a,c,d,e,f){return f.error?(b.clearMessage(),b.setMessage(f.error),b.clearForm(!0),!1):f.isEncoding?(b.isEncoding(),b.processing=!0,b.checkVideoStatus(f.data.id,0),void 0):(b.processing=!1,b.uploaderProgressBar().css("width","100%"),b.uploaderProgressText().html("100%"),b.isProcessed(),b.updatePreview("upload",f.data,f.thumbnail),b.video.isEncoding=!0,b.resetProgress(),void 0)},"{uploaderForm} Error":function(a,d,e,f){var g=c.errors[f.code];b.story.setMessage(g,"error")},"{previewTitle} click":function(){var a=b.form().hasClass("editing-title");b.form().toggleClass("editing-title",!a),a||b.editTitle()},"{previewDescription} click":function(){var a=b.form().hasClass("editing-description");b.form().toggleClass("editing-description",!a),a||b.clickedRemoveButton||b.editDescription()},"{videoCategory} change":function(a){b.currentCategory=a.val()},"{videoLink} paste":function(){setTimeout(function(){b.insertVideo().click()},100)},"{insertVideo} click":function(){var a=b.videoLink().val();a&&!b.processing&&(b.isProcessing(),EasySocial.ajax("ajax:/apps/user/videos/controllers/process/process",{type:"link",link:a}).done(function(c,d){b.isProcessed(),c.link=a,b.updatePreview("link",c,d)}).fail(function(a){b.isProcessed(),b.clearForm(!0),b.story.setMessage(a,"error")}))},"{removeButton} click":function(){b.clickedRemoveButton=!0,b.clearForm(!0),b.clickedRemoveButton=!1,b.renderDefaultPlaceholderDescription=!1},"{story} save":function(d,e,f){if("videos"==f.currentPanel){var g=b.videoLink().val();if(b.saveTitle(),g&&!b.video)return f.reject(c.errors.messages.insert),void 0;if(!g&&!b.video)return f.reject(c.errors.messages.empty),void 0;if(!b.video.title||""==a.trim(b.video.title))return f.reject(c.errors.messages.title),void 0;b.uploadingVideo=f.addTask("uploadingVideo"),b.save(f)}},"{story} afterSubmit":function(){var a=b.uploadingVideo;if(a)return b.clearForm(!0),delete b.uploadingVideo,b.video&&b.video.isEncoding?(EasySocial.dialog({content:EasySocial.ajax("site/views/videos/showEncodingMessage")}),delete b.video,void 0):(delete b.video,void 0)},save:function(a){var d=b.uploadingVideo;if(d){if(b.processing)return a.reject(c.errors.messages.processing),void 0;if(b.video.category=b.videoCategory().val(),!b.video.category||0==b.video.category)return a.reject(c.errors.messages.category),void 0;if(""==b.title().val())return a.reject(c.errors.messages.title),void 0;b.renderDefaultPlaceholderDescription&&(b.video.description=""),a.addData(b,b.video),d.resolve(),b.videoType=b.video.type}},"{story} clear":function(){b.clearForm(!1),b.renderDefaultPlaceholderDescription=!1}}}),b.resolve()})});