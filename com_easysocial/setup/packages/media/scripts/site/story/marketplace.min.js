EasySocial.module("site/story/marketplace",function(a){{var b=this;EasySocial.options.momentLang}EasySocial.require().script("shared/uploader").done(function(){EasySocial.Controller("Story.Marketplace",{defaultOptions:{"{base}":"[data-story-marketplace-base]","{category}":"[data-story-marketplace-category]","{form}":"[data-story-marketplace-form]","{title}":"[data-marketplace-title]","{price}":"[data-marketplace-price]","{description}":"[data-marketplace-description]","{condition}":"[data-marketplace-condition]","{stock}":"[data-marketplace-stock]","{currency}":"[data-marketplace-currency]","{submitButton}":"[data-story-submit]","{conditionWrapper}":"[data-marketplace-condition-wrapper]","{stockWrapper}":"[data-marketplace-stock-wrapper]","{albumView}":"[data-marketplace-view]","{albumContent}":"[data-marketplace-content]","{uploadButton}":"[data-marketplace-upload-button]","{photoItemGroup}":"[data-photo-item-group]","{photoNewItem}":"[data-photo-item][data-photo-edit='0']","{photoItem}":"[data-photo-item]","{photoImage}":"[data-photo-image]","{photoRemoveButton}":"[data-photo-remove-button]","{uploadItem}":"[data-photo-upload-item]","{uploadRemoveButton}":".upload-remove-button","{photoPath}":"[data-field-photo-path]"}},function(b,c){return{init:function(){var a=b.base().htmlData();c.error=a.error||{}},"{category} change":function(d){var f=d.val();return f?(b.story.clearMessage(),b.base().addClass("is-loading"),b.form().show(),b.loadStoryForm(f).done(function(d){return b.base().removeClass("is-loading"),b.form().html(d),0==c.allowCondition&&b.conditionWrapper().addClass("t-hidden"),0==c.allowStock&&b.stockWrapper().addClass("t-hidden"),b.submitButton().removeAttr("disabled"),b.form().find("[data-marketplace-form-error]").length>0?(b.submitButton().attr("disabled","disabled"),void 0):(c.photosRemove=[],b.uploader=b.albumView().addController(EasySocial.Controller.Albums.Uploader,a.extend({"{uploadButton}":b.uploadButton.selector,"{uploadItemGroup}":b.photoItemGroup.selector,"{uploadDropsite}":b.albumContent.selector},{settings:b.options.uploader})),b.photoItemGroup().css("opacity",1),b.addPlugin("uploader",b.uploader),b.setLayout(),void 0)}).fail(function(a){b.base().removeClass("is-loading"),b.story.setMessage(a,"error")}),void 0):(b.base().removeClass("is-loading"),b.form().hide().empty(),void 0)},loadStoryForm:a.memoize(function(a){return EasySocial.ajax("site/controllers/marketplaces/loadStoryForm",{id:a})}),"{story} activatePanel":function(a,c,d){return"marketplace"==d?b.form().find("[data-marketplace-form-error]").length>0?(b.submitButton().attr("disabled","disabled"),void 0):void 0:void 0},"{story} save":function(d,e,f){if("marketplace"==f.currentPanel){var g={title:b.title().val(),description:b.description().val(),condition:b.condition().val(),stock:b.stock().val(),currency:b.currency().val(),price:b.price().val(),category:b.category().val()},h=[];if(b.photoPath().each(function(){h.push(a(this).val())}),h.length<1)return f.reject(c.errors.messages.noEmptyAllowed),void 0;if(g.photos=h,a.isEmpty(g.title))return f.reject(c.errors.messages.title),void 0;if(a.isEmpty(g.description)&&b.description().data("required"))return f.reject(b.description().data("required-message")),void 0;if(a.isEmpty(g.price)&&b.price().data("required"))return f.reject(b.price().data("required-message")),void 0;if(0==a.isNumeric(g.price))return f.reject(c.errors.messages.errorNumeric),void 0;if(1==c.allowStock&&a.isEmpty(g.stock)&&b.stock().data("required"))return f.reject(b.stock().data("required-message")),void 0;b.options.name="marketplace";var i=f.addTask("validateMarketplaceForm");b.save(i,g)}},save:function(a,c){a.save.addData(b,c),a.resolve()},"{story} afterSubmit":function(){b.form().hide().empty(),b.category().val("")},isRequired:function(a){return a.data("required")?(console.log("required"),!1):(console.log("no_required"),!1)},hasItems:function(){var a=b.photoItem().length>0,c=b.uploadItem().length>0;return a||c},setLayout:function(){b.albumView().toggleClass("has-photos",b.hasItems())},activateAttachment:function(){},removePhoto:function(a){a.remove(),"1"==a.data("photoEdit")&&console.log("removedit"),a.remove(),b.setLayout()},clearPhoto:function(){b.photoItem().remove(),b.uploadItem().remove(),b.setLayout()},"{uploader} FilesAdded":function(d,e,f,g){var h=[],i=0;a(g).each(function(a,b){i+=b.size,h.push(b.size)}),EasySocial.ajax("site/controllers/photos/checkFileSize",{filesize:h,totalsize:i,uid:c.uid,utype:c.utype}).done(function(){b.setLayout(),b.uploader.start()}).fail(function(a){b.story.setMessage(a,"error")})},"{uploader} FileUploaded":function(c,d,e,f,g){var h=b.uploader.getItem(f),i=a(a.parseHTML(a.trim(g.html)));i.addClass("new-item").insertAfter(h.element),b.uploader.removeItem(f.id),b.setLayout(),setTimeout(function(){i.removeClass("new-item")},1)},"{uploader} FileError":function(a,c,d,e,f){b.story.setMessage(f.message,"error");var g=b.uploadingPhoto;g&&(g.reject(),delete b.uploadingPhoto),b.uploader.removeItem(e.id),b.setLayout()},"{uploader} Error":function(a,d,e,f){var g=c.errors[f.code]||f.message;b.story.setMessage(g,"error");var h=b.uploadingPhoto;h&&(h.reject(),delete b.uploadingPhoto),b.uploadRemoveButton().click(function(){setTimeout(function(){b.setLayout()},1)}),b.setLayout()},"{photoRemoveButton} click":function(a){var c=a.parent(b.photoItem.selector);b.removePhoto(c)}}}),b.resolve()})});