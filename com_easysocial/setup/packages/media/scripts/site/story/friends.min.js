EasySocial.module("site/story/friends",function(a){var b=this;EasySocial.require().library("textboxlist").done(function(){EasySocial.Controller("Story.Friends",{defaultOptions:{namespace:"site/controllers/friends/suggest",clusterId:null,clusterType:null,"{wrapper}":"[data-friends-wrapper]","{field}":"[data-friends-wrapper] [data-textboxlist-textfield]"}},function(b,c){return{init:function(){b.wrapper().textboxlist({component:"es",plugin:{autocomplete:{exclusive:!0,cache:!1,query:b.search,component:"es",modifier:"es-story-friends-autocomplete",sticky:!0,shadow:!0}}})},search:function(a){var d=b.getTaggedUsers();return EasySocial.ajax(c.namespace,{search:a,exclude:d,clusterId:c.clusterId,clusterType:c.clusterType})},getTaggedUsers:function(){var b=[],c=a("[data-textboxlist-item]");return c.length<=0?b:(a.each(c,function(c,d){var e=a(d).data("id");b.push(e)}),b)},"{wrapper} filterItem":function(b,c,d){var e=a("<div/>").html(d.html),f=e.find("[data-suggest-title]").text(),g=e.find("[data-suggest-id]").val();d.id=g,d.title=f,d.menuHtml=d.html},mention:function(c,d,e){b.search(d).done(function(b){var c=[];a.each(b,function(a,b){c.push({id:b.id,name:b.screenName,avatar:b.avatar,type:"contact"})}),e(c)})},updateMeta:function(){var c=b.wrapper().controller("textboxlist"),d=c.getAddedItems();if(d.length<1)return b.story.setMeta("friends",""),void 0;var e=[];a.each(d,function(a,b){e.push(b.id)}),EasySocial.ajax("site/views/story/buildStoryMeta",{ids:e}).done(function(a){b.story.setMeta("friends",a)})},"{wrapper} addItem":function(){b.updateMeta()},"{wrapper} removeItem":function(){b.updateMeta()},"{story} activateMeta":function(a,c,d){"friends"===d.name&&setTimeout(function(){b.field().focus()},1)},"{story} save":function(a,c,d){var e=b.wrapper().controller("textboxlist"),f=e.getAddedItems().map(function(a){return a.id});d.data.friends_tags=f},"{story} clear":function(){var c=b.wrapper().controller("textboxlist"),d=c.getAddedItems();a.each(d,function(a,b){c.deleteItem(b.id)}),b.story.setMeta("friends","")}}}),b.resolve()})});