EasySocial.module("site/story/audios",function(){var b=this;EasySocial.require().library("image","plupload").done(function(a){EasySocial.Controller("Story.Audios",{defaultOptions:{"{form}":"[data-audio-form]","{panelButton}":'[data-story-plugin-name="audios"]',"{insertAudio}":"[data-insert-audio]","{audioLink}":"[data-audio-link]","{audioGenre}":"[data-audio-genre]","{uploaderForm}":"[data-audio-uploader]","{uploaderButton}":"[data-audio-uploader-button]","{uploaderDropsite}":"[data-audio-uploader-dropsite]","{uploaderProgressBar}":"[data-audio-uploader-progress-bar]","{uploaderProgressText}":"[data-audio-uploader-progress-text]","{uploaderUploadBar}":"[data-audio-uploader-upload-bar]","{uploaderUploadText}":"[data-audio-uploader-upload-text]","{removeButton}":"[data-remove-audio]","{previewImageWrapper}":"[data-audio-preview-image]","{previewTitle}":"[data-audio-preview-title]","{title}":"[data-audio-title]","{previewDescription}":"[data-audio-preview-description]","{description}":"[data-audio-description]","{previewArtist}":"[data-audio-preview-artist]","{artist}":"[data-audio-artist]","{previewAlbum}":"[data-audio-preview-album]","{album}":"[data-audio-album]"}},function(b,c,d){return{init:function(){(0!=b.uploaderForm().length||0!=b.audioLink().length)&&(b.uploaderForm().length>0&&(b.uploader=b.uploaderForm().addController("plupload",a.extend({"{uploadButton}":b.uploaderButton.selector,"{uploadDropsite}":b.uploaderDropsite.selector},c.uploader)),b.plupload=b.uploader.plupload),c.isEdit&&(b.audio={type:c.audio.source,title:c.audio.title,artist:c.audio.artist,album:c.audio.album,description:c.audio.description,link:c.audio.link,id:c.audio.id,isEncoding:c.audio.isEncoding}))},renderDefaultPlaceholderArtist:!1,renderDefaultPlaceholderAlbum:!1,renderDefaultPlaceholderDescription:!1,clickedRemoveButton:!1,isProcessed:function(){b.form().switchClass("is-processed"),b.processing=!1},isUploading:function(){b.form().switchClass("is-uploading")},isProcessing:function(){b.form().switchClass("is-processing"),b.processing=!0},isEncoding:function(){b.form().switchClass("is-encoding")},isInitial:function(){b.form().switchClass("is-waiting")},currentGenre:null,processing:!1,audio:null,audioType:null,updatePreview:function(c,d,e){b.audio={type:c,title:d.title,artist:d.artist,album:d.album,description:d.description,link:d.link,id:d.id?d.id:"",isEncoding:!1},titleContent=b.title().attr("placeholder"),artistContent=b.artist().attr("placeholder"),albumContent=b.album().attr("placeholder"),descriptionContent=b.description().attr("placeholder"),""!=a.trim(d.title)&&(titleContent=d.title,b.title().val(titleContent)),""!=a.trim(d.artist)&&(artistContent=d.artist,b.artist().val(artistContent)),""!=a.trim(d.album)&&(albumContent=d.album,b.album().val(albumContent)),""!=a.trim(d.description)&&(descriptionContent=d.description,b.description().val(descriptionContent),b.previewDescription().removeClass("no-description")),b.previewTitle().html(titleContent),b.previewArtist().html(artistContent),b.previewAlbum().html(albumContent),b.previewDescription().html(descriptionContent),a.Image.get(e).done(function(a){a.appendTo(b.previewImageWrapper())})},resetProgress:function(){b.uploaderProgressBar().css("width","0%"),b.uploaderProgressText().html("0%")},clearForm:function(a){a&&(b.audio=null),b.isInitial(),b.audioLink().val(""),b.previewImageWrapper().empty(),b.previewTitle().empty(),b.title().val(""),b.previewArtist().empty(),b.artist().val(""),b.previewAlbum().empty(),b.album().val(""),b.previewDescription().empty(),b.description().val("")},editArtistEvent:"click.es.story.audio.editLinkArtist",editAlbumEvent:"click.es.story.audio.editLinkAlbum",editTitleEvent:"click.es.story.audio.editLinkTitle",editDescriptionEvent:"click.es.story.audio.editLinkDescription",editTitle:function(){b.form().addClass("editing-title"),setTimeout(function(){b.title().val(b.previewTitle().text()).focus()[0].select(),a(b.title()).on("change keyup paste",function(){b.saveTitle("apply")}),a(document).on(b.editTitleEvent,function(a){a.target!==b.title()[0]&&b.saveTitle("save")})},1)},saveTitle:function(c){if(b.audio){c||(c="save");var d=b.title().val();if("apply"==c)return b.audio.title=d,void 0;d.length>0&&""!=a.trim(d)&&("save"==c&&b.previewTitle().html(d),b.audio.title=d),b.form().removeClass("editing-title"),""==b.audio.title&&b.previewTitle().html().length>0&&(b.audio.title=b.previewTitle().html()),a(document).off(b.editTitleEvent)}},editArtist:function(){b.form().addClass("editing-artist"),setTimeout(function(){b.artist().focus()[0].select(),a(b.artist()).on("change keyup paste",function(){b.saveArtist("apply")}),a(document).on(b.editArtistEvent,function(a){a.target!==b.artist()[0]&&b.saveArtist("save")})},1)},saveArtist:function(c){if(b.audio){c||(c="save");var d=b.artist().val();if("apply"==c)return b.audio.artist=d,void 0;if(b.renderDefaultPlaceholderArtist=!1,"save"==c){var e=""===a.trim(d);e?(d=b.artist().attr("placeholder"),b.renderDefaultPlaceholderArtist=!0,d&&b.previewArtist().html(d.replace(/\n/g,"<br>"))):b.previewArtist().html(d)}b.form().removeClass("editing-artist"),b.audio.artist=d,a(document).off(b.editArtistEvent)}},editAlbum:function(){b.form().addClass("editing-album"),setTimeout(function(){b.album().focus()[0].select(),a(b.album()).on("change keyup paste",function(){b.saveAlbum("apply")}),a(document).on(b.editAlbumEvent,function(a){a.target!==b.album()[0]&&b.saveAlbum("save")})},1)},saveAlbum:function(c){if(b.audio){c||(c="save");var d=b.album().val();if("apply"==c)return b.audio.album=d,void 0;if(b.renderDefaultPlaceholderAlbum=!1,"save"==c){var e=""===a.trim(d);e?(d=b.album().attr("placeholder"),b.renderDefaultPlaceholderAlbum=!0,d&&b.previewAlbum().html(d.replace(/\n/g,"<br>"))):b.previewAlbum().html(d)}b.form().removeClass("editing-album"),b.audio.album=d,a(document).off(b.editAlbumEvent)}},checkAudioStatus:function(a,d){EasySocial.ajax("site/controllers/audios/status",{id:a,uid:c.audio.uid,type:c.audio.type,createStream:0,percentage:d,unpublished:1}).done(function(c,e,f,g){if("done"===e)return b.processing=!1,b.uploaderProgressBar().css("width","100%"),b.uploaderProgressText().html("100%"),b.isProcessed(),b.updatePreview("upload",f,g),b.resetProgress(),void 0;if("ignore"==e)return b.checkAudioStatus(a,d),void 0;var h=e+"%";b.uploaderProgressBar().css("width",h),b.uploaderProgressText().html(h),b.checkAudioStatus(a,e)})},editDescription:function(){b.form().addClass("editing-description"),setTimeout(function(){var d=b.previewDescription().clone(),e=d.hasClass("no-description");d.wrapInner(b.description());var f=b.previewDescription().text();c.isEdit&&e?b.description().val("").focus()[0].select():e?b.description().val("").focus()[0].select():b.description().val(f).focus()[0].select(),a(b.description()).on("change keyup paste",function(){b.saveDescription("apply")}),a(document).on(b.editDescriptionEvent,function(a){a.target!==b.description()[0]&&b.saveDescription("save")})},1)},saveDescription:function(d){if(b.audio){if(d||(d="save"),c.isEdit&&""==a.trim(b.audio.description)&&b.previewDescription().html().length>0)return b.audio.description=b.previewDescription().html(),void 0;var e=b.description().val();switch(e&&(e=e.replace(/\n/g,"<br//>")),b.renderDefaultPlaceholderDescription=!1,d){case"save":var f=""===a.trim(e);b.previewDescription().toggleClass("no-description",f),f&&(e=b.description().attr("placeholder"),b.renderDefaultPlaceholderDescription=!0),e&&b.previewDescription().html(e.replace(/\n/g,"<br>")),b.audio.description=e,b.form().find(".textareaClone").remove(),b.form().removeClass("editing-description"),a(document).off(b.editDescriptionEvent);break;case"apply":""===e&&(b.renderDefaultPlaceholderDescription=!0),b.audio.description=e;case"revert":}}},"{window} easysocial.story.audio.panel.insertaudiolink":function(a,c,d){b.audio||b.processing||!d||(b.panelButton().click(),b.clearForm(!0),b.audioLink().val(d),b.insertAudio().click(),b.story.activatePanel("audios"))},"{uploaderForm} FilesAdded":function(a,c,e,f){var g=d.find("[data-story-cluster]").val(),h=d.find("[data-story-clustertype]").val();EasySocial.ajax("site/controllers/audios/checkFileSize",{filesize:f[0].size,uid:g,utype:h}).done(function(){b.isUploading(),b.plupload.start()}).fail(function(a){b.clearMessage(),b.setMessage(a),b.clearForm(!0)})},"{uploaderForm} UploadProgress":function(a,c,d,e){var f=e.percent+"%";b.uploaderUploadBar().css("width",f),b.uploaderUploadText().html(f)},"{uploaderForm} FileUploaded":function(a,c,d,e,f){return f.error?(b.clearMessage(),b.setMessage(f.error),b.clearForm(!0),!1):f.isEncoding?(b.isEncoding(),b.processing=!0,b.checkAudioStatus(f.data.id,0),void 0):(b.processing=!1,b.uploaderProgressBar().css("width","100%"),b.uploaderProgressText().html("100%"),b.isProcessed(),b.updatePreview("upload",f.data,f.thumbnail),b.audio.isEncoding=!0,b.resetProgress(),void 0)},"{uploaderForm} Error":function(a,d,e,f){var g=c.errors[f.code];b.story.setMessage(g,"error")},"{previewTitle} click":function(){var a=b.form().hasClass("editing-title");b.form().toggleClass("editing-title",!a),a||b.editTitle()},"{previewArtist} click":function(){var a=b.form().hasClass("editing-artist");b.form().toggleClass("editing-artist",!a),a||b.editArtist()},"{previewAlbum} click":function(){var a=b.form().hasClass("editing-album");b.form().toggleClass("editing-album",!a),a||b.editAlbum()},"{previewDescription} click":function(){var a=b.form().hasClass("editing-description");b.form().toggleClass("editing-description",!a),a||b.clickedRemoveButton||b.editDescription()},"{audioGenre} change":function(a){b.currentGenre=a.val()},"{audioLink} paste":function(){setTimeout(function(){b.insertAudio().click()},100)},"{insertAudio} click":function(){var a=b.audioLink().val();a&&!b.processing&&(b.isProcessing(),EasySocial.ajax("ajax:/apps/user/audios/controllers/process/process",{type:"link",link:a}).done(function(c,d){b.isProcessed(),c.link=a,b.updatePreview("link",c,d)}).fail(function(a){b.isProcessed(),b.clearForm(!0),b.story.setMessage(a,"error")}))},"{removeButton} click":function(){b.clickedRemoveButton=!0,b.clearForm(!0),b.clickedRemoveButton=!1,b.renderDefaultPlaceholderArtist=!1,b.renderDefaultPlaceholderAlbum=!1,b.renderDefaultPlaceholderDescription=!1},"{story} save":function(d,e,f){if("audios"==f.currentPanel){c.isEdit&&(b.saveAlbum(),b.saveArtist(),b.saveTitle("apply"),b.saveDescription());var g=b.audioLink().val();if(g&&!b.audio)return f.reject(c.errors.messages.insert),void 0;if(!g&&!b.audio)return f.reject(c.errors.messages.empty),void 0;if(!b.audio.title||""==a.trim(b.audio.title))return f.reject(c.errors.messages.title),void 0;b.uploadingAudio=f.addTask("uploadingAudio"),b.save(f)}},"{story} afterSubmit":function(){var a=b.uploadingAudio;if(a)return b.clearForm(!0),delete b.uploadingAudio,b.audio&&b.audio.isEncoding?(EasySocial.dialog({content:EasySocial.ajax("site/views/audios/showEncodingMessage")}),delete b.audio,void 0):(delete b.audio,void 0)},save:function(a){var d=b.uploadingAudio;if(d){if(b.processing)return a.reject(c.errors.messages.processing),void 0;if(b.audio.genre=b.audioGenre().val(),!b.audio.genre||0==b.audio.genre)return a.reject(c.errors.messages.genre),void 0;b.renderDefaultPlaceholderArtist&&(b.audio.artist=""),b.renderDefaultPlaceholderAlbum&&(b.audio.album=""),b.renderDefaultPlaceholderDescription&&(b.audio.description=""),a.addData(b,b.audio),d.resolve(),b.audioType=b.audio.type}},"{story} clear":function(){b.clearForm(!1),b.renderDefaultPlaceholderArtist=!1,b.renderDefaultPlaceholderAlbum=!1,b.renderDefaultPlaceholderDescription=!1},"{window} easysocial.story.audio.panel.insertaudiolink":function(a,c,d){b.audio||b.processing||!d||(b.panelButton().click(),b.clearForm(!0),b.audioLink().val(d),b.insertAudio().click())}}}),b.resolve()})});