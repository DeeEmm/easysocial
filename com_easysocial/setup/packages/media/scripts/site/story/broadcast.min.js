EasySocial.module("site/story/broadcast",function(){var b=this,c=EasySocial.options.momentLang;EasySocial.require().library("datetimepicker","moment/"+c).done(function(a){EasySocial.Controller("Story.Broadcast",{defaultOptions:{"{base}":"[data-story-event-base]","{profile}":"[data-broadcast-profile]","{title}":"[data-broadcast-title]","{link}":"[data-broadcast-link]","{message}":"[data-broadcast-message]","{type}":"[data-broadcast-type]","{context}":"[data-broadcast-context]","{sendType}":"[data-broadcast-send-type]","{multilist}":"[data-broadcast-multilist]","{sendList}":"[data-broadcast-send-list]","{broadcastExpiry}":"[data-broadcast-expirydate]"}},function(b,c){return{init:function(){b.broadcastExpiry().addController("EasySocial.Controller.Broadcast.Datetime",{"{parent}":b}),"all"==b.sendType().val()?b.multilist().hide():b.multilist().show(),b.loadSelection(b.context().val())},"{sendType} change":function(a){"all"==a.val()?b.multilist().hide():b.multilist().show()},"{type} change":function(a){"notification"==a.val()?b.broadcastExpiry().hide():b.broadcastExpiry().show()},"{context} change":function(a){b.loadSelection(a.val())},"{story} save":function(a,c,d){"broadcast"==d.currentPanel&&(b.savePost=d.addTask("savePost"),b.save(d))},loadSelection:function(a){EasySocial.ajax("apps/user/broadcast/controllers/broadcast/getSelectionItems",{type:a}).done(function(a){b.sendList().html(a)})},save:function(d){var e=b.savePost;if(e){var f=new Array;"all"!=b.sendType().val()&&(f=b.sendList().val());var g=b.title().val(),h=b.link().val(),i=b.message().val(),j=b.type().val(),k=b.context().val();if(a.isEmpty(a.trim(g)))return b.clearMessage(),d.reject(c.error),!1;if(a.isEmpty(a.trim(i)))return b.clearMessage(),d.reject(c.error),!1;if("all"!=b.sendType().val()&&""==f)return b.clearMessage(),d.reject(c.error),!1;var l={broadcast:"1",profileId:f,title:g,content:i,link:h,type:j,context:k};b.broadcastExpiry().trigger("datetimeExport",[l]),d.addData(b,l),e.resolve(),delete b.savePost}},"{story} beforeSubmit":function(a,c,d){"broadcast"==d.currentPanel&&(d.data.content=b.message().val())}}}),EasySocial.Controller("Broadcast.Datetime",{defaultOptions:{"{picker}":"[data-picker]","{toggle}":"[data-picker-toggle]","{datetime}":"[data-datetime]"}},function(b){return{init:function(){var d=new a.moment,e=(new Date).getFullYear()+10,f=b.picker().data("datetimeFormat"),g="DD-MM-YYYY hh:mm A";if(24==f)var g="DD-MM-YYYY HH:mm";d.date(d.date()-1),b.picker()._datetimepicker({component:"es",useCurrent:!1,format:g,minDate:d,maxDate:new a.moment({y:e}),icons:{time:"far fa-clock",date:"fa fa-calendar",up:"fa fa-chevron-up",down:"fa fa-chevron-down"},sideBySide:!1,pickTime:1,minuteStepping:1,language:c});var h=b.element.data("value");if(""!=h){var i=a.moment(h);b.datetimepicker("setDate",i)}},datetimepicker:function(a,c){return b.picker().data("DateTimePicker")[a](c)},"{toggle} click":function(){b.picker().focus()},"{picker} dp.change":function(a,c){b.setDateValue(c.date.toDate())},setDateValue:function(a){b.datetime().val(a.getFullYear()+"-"+("00"+(a.getMonth()+1)).slice(-2)+"-"+("00"+a.getDate()).slice(-2)+" "+("00"+a.getHours()).slice(-2)+":"+("00"+a.getMinutes()).slice(-2)+":"+("00"+a.getSeconds()).slice(-2))},"{self} datetimeExport":function(a,c,d){d.expirydate=b.datetime().val()}}}),b.resolve()})});