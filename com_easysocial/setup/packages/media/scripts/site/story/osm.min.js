EasySocial.module("site/story/osm",function(a){var b=this;EasySocial.require().library("leaflet","scrollTo","image").done(function(){var c={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};EasySocial.Controller("Story.Osm",{defaultOptions:{map:{lat:0,lng:0},mapElementId:"map","{base}":"[data-story-location]","{form}":"[data-story-location-form]","{textField}":"[data-story-location-textField]","{detectButton}":"[data-story-location-detect-button]","{autocomplete}":"[data-story-location-autocomplete]","{suggestions}":"[data-story-location-suggestions]","{suggestion}":"[data-story-location-suggestion]","{textbox}":"[data-story-location-textbox]","{removeButton}":"[data-story-location-remove-button]","{map}":"[data-story-location-map]","{mapImage}":"[data-story-location-map-image]","{meta}":"[data-story-meta-location]"}},function(b){return{init:function(){var a=b.options.currentLocation;b.options.mapElementId&&(b.mapElementId=b.options.mapElementId),navigator.geolocation&&window.es.isHttps&&(b.base().addClass("is-detectable"),b.detectButton().show()),b.textField().removeAttr("disabled"),a&&(b.story.activateMeta("location"),b.initMap(),b.set(a))},initMap:function(){function a(a){var c=a.latlng;b.osm.removeLayer(b.marker),b.marker=L.marker(c).addTo(b.osm),b.osm.setView(c),b.lookupLatLng(c)}b.osm=L.map(b.mapElementId,{zoom:12}),b.osm.fitWorld(),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(b.osm),b.textField().removeAttr("disabled"),b.osm.on("click",a)},"{window} resize":a.debounce(function(){var a=b.currentLocation;if(a){var c=b.mapImage();c.data("width")!==c.width()&&b.navigate(a.latitude,a.longitude)}},250),updateField:function(c){b.textField().val(c[0].name),c=c[0];var d={latitude:c.latitude,longitude:c.longitude,fulladdress:c.formatted_address,formatted_address:c.formatted_address,name:c.formatted_address,address:c.address};b.currentLocation=d;var e=a.Deferred();e.resolve(d),e.done(function(a){EasySocial.ajax("site/views/location/getStoryCaption",{address:c.name}).done(function(a){b.story.setMeta("location",a)}),b.lastQueryAddress=a.fulladdress,b.base().removeClass("is-loading").addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")})},navigate:function(a,c){b.detectButton().addClass("t-hidden");var d={lat:parseFloat(a),lng:parseFloat(c)};void 0!==b.marker&&b.osm.removeLayer(b.marker),b.osm.flyTo(d,10,{duration:3}),b.marker=L.marker(d).addTo(b.osm)},locations:{},lastQueryAddress:null,"{textField} keydown":function(d,e){switch(e.keyCode){case c.UP:var f=a(b.suggestion(".active").prev(b.suggestion.selector)[0]||b.suggestion(":last")[0]);b.suggestion().removeClass("active"),f.addClass("active").trigger("activate"),b.suggestions().scrollTo(f,{offset:-1*f.height()}),e.preventDefault();break;case c.DOWN:var g=a(b.suggestion(".active").next(b.suggestion.selector)[0]||b.suggestion(":first")[0]);b.suggestion().removeClass("active"),g.addClass("active").trigger("activate"),b.suggestions().scrollTo(g,{offset:-1*g.height()}),e.preventDefault();break;case c.ENTER:var h=b.suggestion(".active"),i=h.data("location");void 0!==i&&b.set(i),b.hideSuggestions();break;case c.ESCAPE:b.hideSuggestions()}},"{textField} keyup":function(d,e){switch(e.keyCode){case c.UP:case c.DOWN:case c.LEFT:case c.RIGHT:case c.ENTER:case c.ESCAPE:break;default:var f=a.trim(d.val());""===f&&(b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty"),b.hideSuggestions());var g=b.locations[f];g?(b.lastQueryAddress=f,b.suggest(g)):b.lookup(f)}},lookupLatLng:a.debounce(function(a){b.base().addClass("is-loading"),EasySocial.ajax("site/controllers/location/getLocations",{latitude:a.lat,longitude:a.lng}).done(function(a){b.base().removeClass("is-loading"),b.updateField(a)})},250),lookup:a.debounce(function(a){b.base().addClass("is-loading"),EasySocial.ajax("site/controllers/location/getLocations",{query:a}).done(function(c){b.locations[a]=c,b.suggest(c),b.lastQueryAddress=a})},250),suggest:function(c){var d=b.suggestions();if(d.empty(),!(c.length<0)){var e=[];a.each(c,function(a,b){e.push(b.formatted_address)}),EasySocial.ajax("site/views/location/format",{locations:e}).done(function(b){a.each(b,function(b,e){a(e).data("location",c[b]).appendTo(d)})}),b.showSuggestions(),b.base().removeClass("is-loading")}},showSuggestions:function(){b.focusSuggestion=!0,b.element.find(".es-story-footer").addClass("swap-zindex"),b.story.clearMessage(),setTimeout(function(){b.autocomplete().addClass("active");var c=a(document),d="click.es.story.location";c.off(d).on(d,function(e){var f=a(e.target).parents().andSelf();f.filter(b.element).length>0||(c.off(d),b.hideSuggestions())})},500)},hideSuggestions:function(){b.focusSuggestion=!1,b.autocomplete().removeClass("active"),a(document).off("click.es.story.location"),setTimeout(function(){b.focusSuggestion||b.element.find(".es-story-footer").removeClass("swap-zindex")},500)},"{suggestion} activate":function(a){void 0===b.osm&&b.initMap();var d=a.data("location"),e=d.latitude,f=d.longitude;b.navigate(e,f)},"{suggestion} mouseover":function(a){b.suggestion().removeClass("active"),a.addClass("active").trigger("activate")},"{suggestion} click":function(a){void 0===b.osm&&b.initMap();var d=a.data("location");b.set(d),b.hideSuggestions()},set:function(a){b.currentLocation=a,a.fulladdress=a.name,b.navigate(a.latitude,a.longitude),b.textField().val(a.fulladdress),b.lastQueryAddress=a.address,EasySocial.ajax("site/views/location/getStoryCaption",{address:a.fulladdress}).done(function(a){b.story.setMeta("location",a)}),b.base().removeClass("is-loading").addClass("has-location"),b.map().removeClass("is-empty").addClass("has-data")},unset:function(){void 0!==b.osm&&void 0!==b.marker&&b.osm.removeLayer(b.marker),b.currentLocation=null,b.textField().val(""),b.story.removePanelCaption("locations"),b.story.setMeta("location",""),b.base().removeClass("has-location"),b.map().removeClass("has-data").addClass("is-empty")},activatePanel:function(){setTimeout(function(){b.textField().focus()},500)},deactivatePanel:function(){var a=b.currentLocation;a&&b.set(a)},detectTimer:null,"{detectButton} click":function(){b.detectButton().addClass("is-loading"),b.initMap(),b.osm.locate(),b.osm.on("locationfound",function(a){b.detectButton().removeClass("is-loading"),lat=a.latitude,lng=a.longitude,b.navigate(lat,lng),b.lookupLatLng(a.latlng)})},"{removeButton} click":function(){b.unset(),b.hideSuggestions()},"{meta} click":function(){b.story.activateMeta("location")},"{story} activateMeta":function(a,c,d){"location"===d.name&&setTimeout(function(){b.textField().focus()},1)},"{story} save":function(a,c,d){var e=b.currentLocation;if(e){var f=d.addTask("saveLocation");b.save(f,e)}},save:function(a,b){a.save.data.locations_short_address=b.name,a.save.data.locations_lat=b.latitude,a.save.data.locations_lng=b.longitude,a.save.data.locations_formatted_address=b.fulladdress,a.save.data.locations_data=JSON.stringify(b),a.resolve()},"{story} clear":function(){b.unset(),b.hideSuggestions(),void 0!==b.osm&&(b.osm.remove(),delete b.osm),b.detectButton().removeClass("t-hidden")}}}),b.resolve()})});