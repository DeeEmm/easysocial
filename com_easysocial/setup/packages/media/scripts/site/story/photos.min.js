EasySocial.module("site/story/photos",function(a){var b=this;EasySocial.require().script("shared/uploader").done(function(){EasySocial.Controller("Story.Photos",{defaultOptions:{"{albumView}":"[data-album-view]","{albumContent}":"[data-album-content]","{uploadButton}":"[data-album-upload-button]","{photoItemGroup}":"[data-photo-item-group]","{photoNewItem}":"[data-photo-item][data-photo-edit='0']","{photoItem}":"[data-photo-item]","{photoImage}":"[data-photo-image]","{photoRemoveButton}":"[data-photo-remove-button]","{uploadItem}":"[data-photo-upload-item]","{uploadRemoveButton}":".upload-remove-button"}},function(b,c){return{init:function(){c.photosRemove=[],b.uploader=b.albumView().addController(EasySocial.Controller.Albums.Uploader,a.extend({"{uploadButton}":b.uploadButton.selector,"{uploadItemGroup}":b.photoItemGroup.selector,"{uploadDropsite}":b.albumContent.selector},{settings:b.options.uploader})),b.photoItemGroup().css("opacity",1),b.addPlugin("uploader",b.uploader),b.setLayout()},hasItems:function(){var a=b.photoItem().length>0,c=b.uploadItem().length>0;return a||c},setLayout:function(){b.albumView().toggleClass("has-photos",b.hasItems())},activateAttachment:function(){},removePhoto:function(a){var d=b.photoItem().filterBy("photoId",a);if(b.story.isEdit){var e=b.photoItem().length;if("1"==e){var f=c.errors.noEmptyAllowed;return b.story.setMessage(f,"error")}}"1"==d.data("photoEdit")&&c.photosRemove.push(a),d.remove(),b.setLayout()},clearPhoto:function(){b.photoItem().remove(),b.uploadItem().remove(),b.setLayout()},"{uploader} FilesAdded":function(d,e,f,g){var h=[],i=0;a(g).each(function(a,b){i+=b.size,h.push(b.size)}),EasySocial.ajax("site/controllers/photos/checkFileSize",{filesize:h,totalsize:i,uid:c.uid,utype:c.utype}).done(function(){b.setLayout(),b.uploader.start()}).fail(function(a){b.story.setMessage(a,"error")})},"{uploader} FileUploaded":function(c,d,e,f,g){var h=b.uploader.getItem(f),i=a(a.parseHTML(a.trim(g.html))),j=g.data;i.data("photo",j).addClass("new-item").insertAfter(h.element),b.uploader.removeItem(f.id),b.setLayout(),setTimeout(function(){i.removeClass("new-item")},1),b.save()},"{uploader} FileError":function(a,c,d,e,f){b.story.setMessage(f.message,"error");var g=b.uploadingPhoto;g&&(g.reject(),delete b.uploadingPhoto),b.uploader.removeItem(e.id),b.setLayout()},"{uploader} Error":function(a,d,e,f){var g=c.errors[f.code]||f.message;b.story.setMessage(g,"error");var h=b.uploadingPhoto;h&&(h.reject(),delete b.uploadingPhoto),b.uploadRemoveButton().click(function(){setTimeout(function(){b.setLayout()},1)}),b.setLayout()},"{photoRemoveButton} click":function(a){var c=a.parent(b.photoItem.selector).data("photoId");b.removePhoto(c)},"{story} save":function(a,c,d){b.hasItems()&&(b.uploadingPhoto=d.addTask("uploadingPhoto"),b.save())},save:function(){var d=b.uploadingPhoto;if(d){var e=b.uploadItem();if(e.length<1){var f=[],g=d.save;b.photoNewItem().each(function(){f.push(a(this).data("photoId"))}),c.photosRemove.length>0&&a.each(c.photosRemove,function(a,b){var c={remove:b};f.push(c)}),g.addData(b,f),d.resolve(),delete b.uploadingPhoto}}},"{story} clear":function(){b.clearPhoto()}}}),b.resolve()})});