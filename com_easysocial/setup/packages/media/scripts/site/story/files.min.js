EasySocial.module("site/story/files",function(a){var b=this;EasySocial.require().library("plupload").done(function(){EasySocial.Controller("Story.Files",{defaultOptions:{uid:null,utype:null,"{canvas}":"[data-files-canvas]","{dropsite}":"[data-files-dropsite]","{upload}":"[data-files-upload]","{uploadGroup}":"[data-files-items]","{fileItem}":"[data-files-item]","{fileNewItem}":"[data-files-item][data-edit='0']","{removeItem}":"[data-files-item-remove]","{uploadItem}":"[data-files-upload-item]","{progressTemplate}":"[data-files-progress]",settings:{url:null,max_file_size:null,filters:[]}}},function(b,c){return{items:{},init:function(){c.filesRemove=[],c.hints={progress:b.progressTemplate().clone().html()},b.progressTemplate().remove();var d=a.extend({"{uploadButton}":b.upload.selector,"{uploadDropsite}":b.dropsite.selector},{settings:b.options.settings});b.uploader=b.canvas().addController("plupload",d),b.plupload=b.uploader.plupload,b.addPlugin("uploader",b.uploader),a.IE||"html5"!=b.plupload.runtime||b.canvas().addClass("can-drop-file"),b.canvas().addClass("can-upload"),b.setLayout()},hasItems:function(){var a=b.fileItem().length>0,c=b.uploadItem().length>0;return a||c},setLayout:function(){b.canvas().toggleClass("has-items",b.hasItems())},removeFile:function(a){var d=b.fileItem().where("id",a);"1"==d.data("edit")&&c.filesRemove.push(a),d.remove(),b.setLayout()},clearFiles:function(){b.fileItem().remove(),b.uploadItem().remove(),b.setLayout()},removeFileItem:function(a){var c=b.getItem(a);c&&(b.plupload.removeFile(c.file()),c.element.remove(),delete b.items[a],b.setLayout())},getItem:function(c){var d;return a.isString(c)&&(d=c),c&&c.id&&(d=c.id),b.items[d]},createItem:function(d){var e=a(c.hints.progress);return e.attr("id",d.id),b.uploadGroup().append(e),b.items[d.id]=e,b.setLayout(),b.trigger("QueueCreated",[e]),e},"{uploader} FilesAdded":function(d,e,f,g){var h=[],i=0;try{g.reverse(),a.each(g,function(a,c){b.getItem(c)||(b.createItem(c),i+=c.size,h.push(c.size))})}catch(j){console.error(j)}b.setLayout(),EasySocial.ajax("site/controllers/explorer/checkFileSize",{filesize:h,totalsize:i,uid:c.uid,utype:c.utype}).done(function(){b.uploader.plupload.start()}).fail(function(a){b.story.setMessage(a,"error")})},"{uploader} FileUploaded":function(c,d,e,f,g){var h=b.getItem(f),i=a(g.preview);i.data("file-id",g.id).addClass("new-item").insertAfter(h),h.remove(),b.setLayout(),setTimeout(function(){i.removeClass("new-item")},1)},"{uploader} UploadProgress":function(c,d,e,f){var g=b.getItem(f);if(g){var h=void 0===f.size||"N/A"==f.size;f.percentage=f.percent+"%",f.filesize=h?"":a.plupload.formatSize(f.size),f.remaining=h?"":a.plupload.formatSize(f.size-(f.loaded||0));var i=f.percentage;"100%"==i&&(i="99%"),"0%"==i&&(i="1%"),g.find(".upload-progress-bar").width(i),g.find(".upload-percentage").html(i)}},"{uploader} FileError":function(a,c,d,e,f){b.story.setMessage(f.message,"error");var g=b.uploadingFile;g&&(g.reject(),delete b.uploadingFile),b.setLayout()},"{uploader} Error":function(a,d,e,f){var g=c.errors[f.code]||f.message;b.story.setMessage(g,"error");var h=b.uploadingFile;h&&(h.reject(),delete b.uploadingFile),b.removeItem().click(function(){setTimeout(function(){b.setLayout()},1)}),b.setLayout()},"{removeItem} click":function(a){var c=a.parent(b.fileItem.selector).data("id");b.removeFile(c)},"{story} save":function(a,c,d){b.hasItems()&&(b.uploadingFile=d.addTask("uploadingFile"),b.save())},save:function(){var d=b.uploadingFile;if(d){var e=b.fileItem();if(e.length){var f=[];save=d.save,b.fileNewItem().each(function(){f.push(a(this).data("id"))}),c.filesRemove.length>0&&a.each(c.filesRemove,function(a,b){var c={remove:b};f.push(c)}),save.addData(b,f),d.resolve(),delete b.uploadingFile}}},"{story} clear":function(){b.clearFiles()}}}),b.resolve()})});