EasySocial.module("site/story/links",function(a){var b=this;EasySocial.Controller("Story.Links",{defaultOptions:{urlParser:null,validateUrl:!1,"{linkForm}":"[data-story-link-form]","{linkInput}":"[data-story-link-input]","{linkContent}":"[data-story-link-content]","{linkItem}":"[data-story-link-item]","{linkTitle}":"[data-story-link-title]","{linkDescription}":"[data-story-link-description]","{linkImages}":"[data-story-link-images]","{linkImage}":"[data-story-link-image]","{imageWrapper}":"[data-story-link-image-wrapper]","{linkVideo}":"[data-story-link-video]","{titleTextfield}":"[data-story-link-title-textfield]","{descriptionTextfield}":"[data-story-link-description-textfield]","{panelButton}":"[data-story-link-panel-button]","{attachButton}":"[data-story-link-attach-button]","{removeButton}":"[data-story-link-remove-button]","{removeThumbnail}":"[data-story-link-remove-image]"}},function(b,c){return{init:function(){if(c.isEdit){var d={title:c.link.title,description:c.link.description,url:c.link.url,image:c.link.image},e=a("[data-story-link-edit]");d.item=a(e).data("link",d),d.item.addController(EasySocial.Controller.Story.Links.Preview),b.currentLink=d}},activateAttachment:function(){b.doNotFocus||setTimeout(function(){b.linkInput().focus(),b.doNotFocus=!1},500)},links:{},currentLink:null,crawling:!1,extractUrls:function(c){var d=b.options.urlParser,e=c.match(d);return a.isArray(e)?a.map(e,function(b){return a.trim(b)}):[]},fixUrl:function(b){var b=a.uri(b);return/http|https/.test(b.protocol())||b.setProtocol("http"),b.toString()},getLink:function(d){if(a.isString(d)&&(d=b.extractUrls(d)),d.length<1){var e=a.Deferred();return e.reject(c.errors.messages.tlds),e}var f=d[0];return link=b.links[f]||b.createLink(f)},createLink:function(c){var d=b.links[c]=a.Deferred();return d.url=c,b.crawling=!0,EasySocial.ajax("site/controllers/crawler/fetch",{url:c,preview:1}).done(function(b,c){b||d.reject(),d.item=a(c).data("link",b),d.item.addController(EasySocial.Controller.Story.Links.Preview),d.resolve(d)}).fail(function(a){d.reject(a)}).always(function(){b.crawling=!1}),d},addLink:function(a){b.linkContent().empty().append(a.item),b.linkForm().hide(),b.currentLink=a},removeLink:function(){b.linkItem().detach(),b.linkForm().show(),b.currentLink=null},checkAllowedPanel:function(){var b=["links","text"],c=!1;return a.each(b,function(b,d){var e='[data-story-plugin-name="'+d+'"]',f=a(e);return f.hasClass("active")?(c=!0,!1):void 0}),c},checkVideoLink:function(c){var d=b.story.panelContent('[data-story-plugin-name="videos"]'),e=a(d).find("[data-video-form]").data("allow-link");if(!e)return!1;var f=c.match(/(youtube|dailymotion|twitch|liveleak)\.(com|tv)\/((watch\?v=([-\w]+))|(view\?i=([-\w]+))|((video|videos)\/([-\w]+)))/),g=c.match(/(vimeo)\.(com)\/(([-\w]+))/),h=c.match(/twitch.tv/),i=c.match(/www\.tiktok\.com/),j=c.match(/youtu\.be\/([-\w]+)/),k=c.match(/youtube\.com\/([-\w]+)\/live/);return null!==f||null!==g||null!==h||null!==i||null!==j||null!==k?!0:!1},checkAudioLink:function(c){var d=b.story.panelContent('[data-story-plugin-name="audios"]'),e=a(d).find("[data-audio-form]").data("allow-link");if(!e)return!1;var f=c.match(/^(spotify:|https:\/\/(open|play)+\.spotify\.com\/)/),g=c.match(/^https?:\/\/(soundcloud\.com|snd\.sc)\/(.*)$/);return null!==f||null!==g?!0:!1},"{attachButton} click":function(){var d=(b.linkInput(),b.linkForm()),e=a.trim(b.linkInput().val());""!==e&&(e=b.fixUrl(e),b.linkInput().val(e),d.addClass("busy"),b.getLink(e).done(function(a){b.addLink(a)}).fail(function(a){b.story.setMessage(a,"error")}).always(function(){d.removeClass("busy")}))},"{removeButton} click":function(){b.currentLink.disabled=!0,b.removeLink()},"{linkInput} keyup":function(a,c){13==c.keyCode&&b.attachButton().click()},"{linkInput} paste":function(){setTimeout(function(){b.attachButton().click()},100)},"{story.textField} input":a._.debounce(function(c){if(!b.currentLink&&!b.crawling){var e=c.val(),f=b.extractUrls(e),g=f[f.length-1];if(g){if(videoLink=b.checkVideoLink(g))return a(window).trigger("easysocial.story.video.panel.insertvideolink",[g]),void 0;if(audioLink=b.checkAudioLink(g))return a(window).trigger("easysocial.story.audio.panel.insertaudiolink",[g]),void 0;if(b.checkAllowedPanel()){var g=b.fixUrl(g),h=b.links[g];if(!h||!h.disabled){if(b.options.validateUrl){return EasySocial.ajax("site/controllers/crawler/validate",{url:g}).done(function(){b.linkInput().val(g),b.doNotFocus=!0,b.panelButton().click(),b.attachButton().click()}),void 0}b.linkInput().val(g),b.doNotFocus=!0,b.panelButton().click(),b.attachButton().click()}}}}},950),"{story} save":function(a,d,e){if("links"==e.currentPanel){if(!b.currentLink)return e.reject(c.errors.messages.insert),void 0;var f={title:b.titleTextfield().val(),description:b.descriptionTextfield().val(),url:b.currentLink.url,video:b.linkVideo().val()};b.removeThumbnail().is(":checked")||(f.image=b.imageWrapper(".active").find("img").attr("src")),e.addData(b,f)}},"{story} clear":function(){b.linkInput().val(""),b.removeLink()}}}),EasySocial.Controller("Story.Links.Preview",{defaultOptions:{"{previousImage}":"[data-story-link-image-prev]","{nextImage}":"[data-story-link-image-next]","{image}":"[data-story-link-image]","{imageWrapper}":"[data-story-link-image-wrapper]","{imagesWrapper}":"[data-story-link-images]","{imageIndex}":"[data-story-link-image-index]","{removeThumbnail}":"[data-story-link-remove-image]","{imageDimensions}":"[data-story-link-image-dimensions]","{imageWidth}":"[data-image-width]","{imageHeight}":"[data-image-height]","{title}":"[data-story-link-title]","{description}":"[data-story-link-description]","{titleTextfield}":"[data-story-link-title-textfield]","{descriptionTextfield}":"[data-story-link-description-textfield]"}},function(b){return{init:function(){b.initDimensions()},initDimensions:function(){b.image().on("load",function(){var c=this.naturalWidth,d=this.naturalHeight,e=a(this).parent();e.find(b.imageWidth.selector).html(c),e.find(b.imageHeight.selector).html(d)})},"{removeThumbnail} click":function(){var a=b.removeThumbnail().is(":checked");a?b.imagesWrapper().hide():b.imagesWrapper().show(),b.element.toggleClass("has-images",!a)},"{previousImage} click":function(){var a=b.imageWrapper(".active"),c=a.prev(),d=parseInt(b.imageIndex().html()),e=d-1;c.length>0&&(a.removeClass("active"),c.addClass("active"),b.imageIndex().html(e))},"{nextImage} click":function(){var a=b.imageWrapper(".active"),c=a.next(),d=parseInt(b.imageIndex().html()),e=d+1;c.length>0&&(a.removeClass("active"),c.addClass("active"),b.imageIndex().html(e))},"{title} click":function(){var a=b.element.hasClass("editing-title");b.element.toggleClass("editing-title",!a),a||b.editTitle()},editTitleEvent:"click.es.story.editLinkTitle",editTitle:function(){b.element.addClass("editing-title"),setTimeout(function(){b.titleTextfield().val(b.title().text()).focus()[0].select(),a(document).on(b.editTitleEvent,function(a){a.target!==b.titleTextfield()[0]&&b.saveTitle("save")})},1)},saveTitle:function(c){c||(c=save);var d=b.titleTextfield().val();"save"==c&&(""===d&&(d=b.title().data("default")),b.title().html(d)),b.element.removeClass("editing-title"),a(document).off(b.editTitleEvent)},"{titleTextfield} keyup":function(a,c){27==c.keyCode&&b.saveTitle("revert")},"{description} click":function(){var a=b.element.hasClass("editing-description");b.element.toggleClass("editing-description",!a),a||b.editDescription()},editDescriptionEvent:"click.es.story.editLinkDescription",editDescription:function(){b.element.addClass("editing-description"),setTimeout(function(){var c=b.description().clone(),d=c.hasClass("no-description");c.wrapInner(b.descriptionTextfield()),d&&b.descriptionTextfield().val(""),b.descriptionTextfield().focus()[0].select(),a(document).on(b.editDescriptionEvent,function(a){a.target!==b.descriptionTextfield()[0]&&b.saveDescription("save")})},1)},saveDescription:function(c){c||(c=save);var d=b.descriptionTextfield().val().replace(/\n/g,"<br//>");switch(c){case"save":var e=""===d;b.description().toggleClass("no-description",e),e&&(d=b.descriptionTextfield().attr("placeholder")),b.description().html(d);break;case"revert":}b.element.find(".textareaClone").remove(),b.element.removeClass("editing-description"),a(document).off(b.editDescriptionEvent)},"{descriptionTextfield} keyup":function(a,c){27==c.keyCode&&b.saveDescription("revert")}}}),b.resolve()});