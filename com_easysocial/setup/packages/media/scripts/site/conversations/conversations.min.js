EasySocial.module("site/conversations/conversations",function(){var b=this;EasySocial.require().library("scrollTo").script("site/conversations/composer","site/conversations/item").done(function(a){EasySocial.Controller("Conversations",{defaultOptions:{attachments:!0,location:!0,maxSize:"3mb",extensionsAllowed:"",isMobile:!1,enterToSubmit:!1,attachmentController:null,locationController:null,composerController:null,"{tabs}":"[data-es-tab]","{contents}":"[data-contents]","{conversationHeader}":"[data-es-conversation-header]","{listWrapper}":"[data-es-list]","{contentsWrapper}":"[data-es-contents-wrapper]","{lists}":"[data-es-list-items]","{listItem}":"[data-es-item]","{emptyListSidebar}":"[data-es-list-empty]","{emptyContents}":"[data-es-content-empty]","{emptyActionBtn}":"[data-es-action-btn-empty]","{scroller}":"[data-es-scroller]","{latestWrapper}":"[data-es-latest]","{messageContent}":"[data-es-messages]","{messageItems}":"[data-es-message]","{toolDropDown}":"[data-item-tools]","{unreadButton}":"[data-es-unread]","{archiveButton}":"[data-es-archive]","{unarchiveButton}":"[data-es-unarchive]","{leaveButton}":"[data-es-leave]","{deleteButton}":"[data-es-delete]","{addParticipant}":"[data-es-addparticipant]","{viewParticipants}":"[data-es-viewparticipants]","{editTitle}":"[data-es-rename]","{composer}":"[data-es-composer]","{attachments}":"[data-uploaderQueue-id]","{replyForm}":"[data-es-reply-form]","{replyButton}":"[data-es-reply-button]","{attachmentForm}":"[data-es-attachment-form]","{attachmentToggle}":"[data-es-attachment-toggle]","{emoticonsToggle}":"[data-comment-smileys]","{attachmentCloseBtn}":"[data-es-attachment-close]","{locationForm}":"[data-es-location-form]","{locationToggle}":"[data-es-location-toggle]","{conversationTitle}":"[data-es-title]","{conversationActions}":"[data-es-actions]","{titleContainer}":"[data-es-title-container]","{titleInputBox}":"[data-es-title-textbox]","{titleSaveButton}":"[data-title-save]","{titleCancelButton}":"[data-title-cancel]","{giphyButton}":"[data-giphy-button]","{giphyPlaceholder}":"[data-giphy-item-preview-placeholder]","{giphyPreview}":"[data-giphy-item-preview]","{item}":"[data-item]","{itemMenuDropdown}":"[data-menu-dropdown]","{itemMenu}":"[data-item-menu]","{listTitleInput}":"[data-es-title-textbox-list]","{listTitleSaveButton}":"[data-title-save-list]","{listRenameTitleButton}":"[data-es-rename-list]","{typing}":"[data-typing]","{search}":"[data-es-search]","{backBtn}":"[data-back-button]","{pagination}":"[data-es-conversation-pagination]","{paginationWrapper}":"[data-es-conversation-pagination-wrapper]","{smileyItem}":"[data-comment-smiley-item]"}},function(b,c){return{init:function(){b.composer().implement(EasySocial.Controller.Conversations.Composer,{"{parent}":b,"{uploader}":"[data-es-attachment-form]","{location}":"[data-es-location]",maxSize:b.options.maxSize,extensionsAllowed:b.options.extensionsAllowed,emoticons:b.options.emoticons}),b.options.composerController=b.composer().controller(),c.attachments&&(b.options.attachmentController=b.options.composerController.uploader().controller()),b.options.location&&(b.options.locationController=b.options.composerController.location().controller()),b.messageContent().implement(EasySocial.Controller.Conversations.Message,{"{parent}":b}),b.lists().implement(EasySocial.Controller.Conversations.Item,{"{parent}":b}),b.goToLatest()},setActiveTab:function(a){b.tabs().removeClass("active"),a.addClass("active"),b.wrapperEmpty(!1),b.loading(!0),b.conversationTitle().empty()},getConversationItem:function(a){var c=a.closest(b.item.selector);return c},searchConversation:a.debounce(function(a){var c=b.pagination().data("type");EasySocial.ajax("site/views/conversations/getConversations",{type:c,keyword:a}).done(function(a){b.lists().html(a)}).always(function(){})},250),filter:a.debounce(function(c){var d=b.listItem().length;if(!(0>=d)){if(b.listWrapper().removeClass("is-empty"),!c||!(c=a.trim(c))||c.length<=2)return b.listItem().show(),void 0;b.listItem().show();var e=b.listItem().filter(function(){return a(this).data("title").indexOf(c.toLowerCase())<=-1?this:void 0});e.length==d&&b.listWrapper().addClass("is-empty"),e.hide()}},250),"{composer} save":function(){b.replyButton().click()},"{search} keyup":function(){var a=b.search().val();b.searchConversation(a)},"{itemMenuDropdown} click":function(a,b){b.preventDefault(),b.stopPropagation();var c=a.parents("[data-es-list-items]");c.find("[data-item]").removeClass("is-dropdown"),a.closest("[data-item]").addClass("is-dropdown");var d=a.find("[data-es-toggle]");d.trigger("click.bs.dropdown")},"{itemMenu} click":function(a){var d=b.getConversationItem(a),e=d.data("id"),f=a.data("item-menu");return"unread"==f?(b.setUnread(e),void 0):(b.showDialog(f,e),void 0)},"{listItem} click":function(){b.conversationHeader().hasClass("is-editing")&&b.toggleTitleEditForm()},loadMore:function(){var a=b.pagination().data("type"),c=b.pagination().data("limitstart");0>c||(b.moreLoading=!0,b.pagination().addClass("is-loading"),EasySocial.ajax("site/views/conversations/getConversations",{type:a,limitstart:c,loadmore:1}).done(function(a,c,d,e){b.pagination().data("limitstart",e),b.lists().append(a),0>e&&b.paginationWrapper().addClass("t-hidden");try{MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub])}catch(f){}}).always(function(){b.pagination().removeClass("is-loading"),b.moreLoading=!1}))},"{pagination} click":function(){b.loadMore()},"{tabs} click":function(a,c){c.stopPropagation(),c.preventDefault();var d=a.find("> a");d.route(),b.setActiveTab(a);var e=a.data("es-tab");EasySocial.ajax("site/views/conversations/getConversations",{type:e}).done(function(a,c,d,f){if(b.contents().removeClass("has-active"),b.pagination().attr("data-type",e).data("type",e),a.length<1?(b.pagination().data("limitstart","0"),b.wrapperEmpty(!0,e,c,d),b.replyForm().addClass("t-hidden"),b.paginationWrapper().addClass("t-hidden")):(b.pagination().data("limitstart",f),b.contents().addClass("has-active"),b.replyForm().removeClass("t-hidden"),0>f?b.paginationWrapper().addClass("t-hidden"):b.paginationWrapper().removeClass("t-hidden")),b.lists().html(a),!b.options.isMobile){var g=b.lists().children(":first").find("[data-es-conversation]");g.trigger("click")}b.loading(!1)})},"{backBtn} click":function(){b.trigger("togglees.conversation")},"{deleteButton} click":function(){var a=b.replyForm().data("id");b.showDialog("Delete",a)},"{archiveButton} click":function(){var a=b.replyForm().data("id");b.showDialog("Archive",a)},"{unarchiveButton} click":function(){var a=b.replyForm().data("id");b.showDialog("Unarchive",a)},"{leaveButton} click":function(){var a=b.replyForm().data("id");b.showDialog("Leave",a)},"{unreadButton} click":function(){var a=b.replyForm().data("id");b.setUnread(a)},"{addParticipant} click":function(){var a=b.replyForm().data("id");b.showInviteForm(a)},"{viewParticipants} click":function(){var a=b.replyForm().data("id");b.showParticipants(a)},"{attachmentToggle} click":function(a,c){c.preventDefault(),b.attachmentForm().toggleClass("t-hidden")},"{emoticonsToggle} click":function(a,b){return b.preventDefault(),a.hasClass("active")?(a.removeClass("active"),void 0):(a.addClass("active"),void 0)},"{attachmentCloseBtn} click":function(){b.attachmentForm().toggleClass("t-hidden")},"{locationToggle} click":function(a,c){c.preventDefault(),b.locationForm().toggleClass("t-hidden")},"{editTitle} click":function(){b.toggleTitleEditForm();var d=b.conversationTitle().text();d=d.trim(),b.titleInputBox().val(d),b.titleInputBox().focus()},"{titleInputBox} keydown":function(a,c){var d=a.parents("[data-es-title-container]"),e=d.find("[data-title-save]");13==c.keyCode&&(e.trigger("click"),c.preventDefault()),27==c.keyCode&&b.toggleTitleEditForm()},"{listTitleInput} keydown":function(a,c){var d=a.parents("[data-es-item]"),e=d.find("[data-title-save-list]");13==c.keyCode&&(e.trigger("click"),c.preventDefault()),27==c.keyCode&&b.toggleItemTitle(d)},"{listRenameTitleButton} click":function(a){var d=a.parents("[data-es-item]");b.toggleItemTitle(d);var e=d.find("[data-item-title]").text().trim(),f=d.find("[data-es-title-textbox-list]");f.val(e),f.focus()},toggleItemTitle:function(b){var c=b.find("[data-item-title-textbox]"),d=b.find("[data-item-title]");a(d).removeClass("t-hidden"),b.removeClass("is-editing-title");var e=a(c).toggleClass("t-hidden").hasClass("t-hidden");e||(a(d).addClass("t-hidden"),b.addClass("is-editing-title"))},toggleTitleEditForm:function(){b.conversationHeader().toggleClass("is-editing"),b.titleInputBox().val("")},"{titleCancelButton} click":function(){b.toggleTitleEditForm()},"{titleSaveButton} click":function(){b.titleSaveButton().attr("disabled",!0);var d=b.replyForm().data("id"),e=b.titleInputBox().val();if(""==e.trim())return b.titleSaveButton().attr("disabled",!1),void 0;var f={id:d,title:e};EasySocial.ajax("site/controllers/conversations/updateTitle",f).done(function(a){b.conversationTitle().text(a),b.updateListTitle(d,a),b.toggleTitleEditForm()}).fail(function(a){EasySocial.dialog({content:a.message})}).always(function(){b.titleSaveButton().attr("disabled",!1)})},"{listTitleSaveButton} click":function(c){a(c).attr("disabled",!0);var e=c.parents("[data-es-item]"),f=e.data("id"),g=e.find("[data-es-title-textbox-list]").val(),h={id:f,title:g};EasySocial.ajax("site/controllers/conversations/updateTitle",h).done(function(a){parentId=b.replyForm().data("id"),parentId==f&&b.conversationTitle().text(a),b.updateListTitle(f,a),b.toggleItemTitle(e)}).fail(function(a){EasySocial.dialog({content:a.message})}).always(function(){a(c).attr("disabled",!1)})},updateListTitle:function(b,c){var d=a('[data-es-item][data-id="'+b+'"]');d.length>0&&(d.data("title",c),d.find("[data-link]").attr("title",c),d.find("[data-item-title]").text(c))},isReplying:!1,toggleReplyButton:function(a){b.replyForm().toggleClass("is-uploading",a),b.replyButton().toggleClass("disabled",a)},"{replyButton} click":function(d,e){if(b.replyForm().hasClass("is-uploading"))return!1;e.preventDefault();var f=b.replyForm().data("id"),g=c.composerController.editor().val(),h=new Array;if(c.attachments&&b.attachments().each(function(b,c){var d=a(c).val();d&&h.push(a(c).val())}),g.length<=0&&h.length<=0)return!1;if(b.isReplying)return!1;b.isReplying=!0;var i={id:f,message:g},j=c.composerController.getHoneyPot();if(j&&(i=a.extend(i,j)),b.options.attachments&&(i["upload-id"]=h),b.options.location){var k=b.composer().controller().location().controller();i.address=k.textField().val(),i.latitude=k.latitude().val(),i.longitude=k.longitude().val()}return i.tags=b.composer().controller().editorArea().mentions("controller").toArray(),i.tags=a.map(i.tags,function(b){return"emoticon"===b.type&&a.isPlainObject(b.value)&&(b.value=b.value.title.slice(1)),JSON.stringify(b)}),b.replyButton().attr("disabled",!0),b.submitReply(i),!1},insertGiphy:function(a){var c=a.data("original"),d=b.replyForm().data("id"),e={id:d,message:c,giphy:!0,type:"giphy"};b.submitReply(e)},bindClickGiphyItem:function(c){c.tooltip.find("[data-giphy-item]").off("click.giphy.conversation.form").on("click.giphy.conversation.form",function(){var d=a(this);b.insertGiphy(d),c.hide()})},"{giphyButton} popboxActivate":function(a,c,d){c.stopPropagation(),d.tooltip.find("[data-popbox-content]").off("giphyAfterSearch").on("giphyAfterSearch",function(){b.bindClickGiphyItem(d)}),b.bindClickGiphyItem(d)},submitReply:function(c){EasySocial.ajax("site/controllers/conversations/reply",c).done(function(d,e,f){a('[data-es-item][data-id="'+c.id+'"]').data("lastupdate",f);var g=a(e);b.messageContent().append(g),c.giphy||b.resetForm(),b.goToLatest(),g.find("[data-giphy-item-preview-placeholder]").addClass("is-loading"),g.find("[data-giphy-item-preview]").off("load").on("load",function(){g.find("[data-giphy-item-preview-placeholder]").removeClass("is-loading")})}).fail(function(a){EasySocial.dialog({content:a.message})}).always(function(){b.replyButton().attr("disabled",!1),b.isReplying=!1})},getLanguageString:function(b){return a('[data-id="'+b+'"]').text()},resetForm:function(){b.options.composerController.resetForm();var a=b.composer().controller().editorArea().mentions("controller");if(a.reset(),b.options.location){var c=b.composer().controller().location().controller();c.unset(),b.locationForm().addClass("t-hidden")}b.options.attachments&&(b.options.attachmentController.reset(),b.attachmentForm().addClass("t-hidden"))},loading:function(a){a?(b.listWrapper().addClass("is-loading"),b.contentsWrapper().addClass("is-loading")):(b.listWrapper().removeClass("is-loading"),b.contentsWrapper().removeClass("is-loading"))},wrapperEmpty:function(a,c,d,e){a?(b.emptyListSidebar().find("div.o-empty__text").html(d),b.emptyContents().find("div.o-empty__text").html(e),"archives"==c?(b.emptyActionBtn().addClass("t-hidden"),b.toolDropDown().addClass("t-hidden")):(b.emptyActionBtn().removeClass("t-hidden"),b.toolDropDown().removeClass("t-hidden")),b.editTitle().addClass("t-hidden"),b.listWrapper().addClass("is-empty"),b.contentsWrapper().addClass("is-empty")):(b.listWrapper().removeClass("is-empty"),b.contentsWrapper().removeClass("is-empty"),b.toolDropDown().removeClass("t-hidden"),b.editTitle().removeClass("t-hidden"))},setActiveConversation:function(a){b.listItem().removeClass("is-active"),a.addClass("is-active"),a.removeClass("is-unread"),b.toolDropDown().removeClass("hidden"),b.goToLatest()},goToLatest:function(){b.scroller().scrollTo(b.latestWrapper(),250,{offset:{top:-100}})},showDialog:function(a,b){var c=a.charAt(0).toUpperCase()+a.slice(1);EasySocial.dialog({content:EasySocial.ajax("site/views/conversations/confirm"+c,{id:b})})},showInviteForm:function(a){EasySocial.dialog({content:EasySocial.ajax("site/views/conversations/addParticipantsForm",{id:a})})},showParticipants:function(a){EasySocial.dialog({content:EasySocial.ajax("site/views/conversations/viewParticipants",{id:a})})},setUnread:function(b){EasySocial.ajax("site/controllers/conversations/markUnread",{id:b}).done(function(){var c=a('[data-es-item][data-id="'+b+'"]');c.length>0&&(c.removeClass("is-active"),c.addClass("is-unread"))}).fail(function(a){EasySocial.dialog({content:a})})},"{smileyItem} click":function(a){var d=b.composer().controller().editorArea(),e=a.data("comment-smiley-value");e+=" ";var f=d.mentions("controller"),g=f.textarea();previousCursor=f.previousCursorPosition;var h=g.val(),i=h.substring(0,previousCursor)+e,j=i+h.substring(previousCursor);f.isPasting=!0,f.smileyLength=e.length,g.val(j),g.trigger("input"),f.moveCursor(i.length)}}}),b.resolve()})});